{% extends "base.html" %}

{% block title %}歌单订阅 - TGmusicbot{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-2xl font-bold mb-1">歌单订阅</h2>
    <p class="text-gray-500">自动同步的歌单列表，定时检查更新</p>
</div>

<!-- 统计 -->
<div class="glass-card p-6 mb-8">
    <div class="flex items-center gap-6">
        <div
            class="w-16 h-16 rounded-2xl bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center">
            <i class="fas fa-rss text-2xl text-white"></i>
        </div>
        <div>
            <p class="text-4xl font-bold" id="subscription-count">--</p>
            <p class="text-gray-500">订阅歌单总数</p>
        </div>
        <div class="ml-auto text-right">
            <p class="text-sm text-gray-400"><i class="fas fa-clock mr-1"></i>检查间隔</p>
            <p class="text-lg font-semibold text-green-400" id="sync-interval">加载中...</p>
        </div>
    </div>
</div>

<!-- 订阅列表 -->
<div class="glass-card overflow-hidden">
    <table class="data-table">
        <thead>
            <tr>
                <th>歌单信息</th>
                <th>平台</th>
                <th>歌曲数</th>
                <th>最后同步</th>
                <th>可见性</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="subscription-table">
            <tr>
                <td colspan="7" class="text-center text-gray-500 py-12">
                    <i class="fas fa-spinner fa-spin mr-2"></i>加载中...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- 说明 -->
<div class="glass-card p-6 mt-8">
    <h4 class="font-semibold text-blue-400 mb-3"><i class="fas fa-info-circle mr-2"></i>订阅说明</h4>
    <ul class="text-gray-400 text-sm space-y-2">
        <li><i class="fas fa-check text-green-400 mr-2"></i>同步歌单后会自动订阅，无需手动操作</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>系统定时检查歌单是否有新歌（可在设置中配置间隔）</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>发现新歌时会通过 Telegram 通知用户</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>"可见性"设置为公开时，其他用户可在 Emby 中看到您的歌单</li>
        <li><i class="fas fa-check text-green-400 mr-2"></i>可以在 Telegram 中使用 /sub 查看订阅，/unsub 取消订阅</li>
    </ul>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function loadSubscriptions() {
        try {
            const res = await fetch('/api/subscriptions');
            const data = await res.json();
            const tbody = document.getElementById('subscription-table');
            const subscriptions = data.subscriptions || [];

            document.getElementById('subscription-count').textContent = subscriptions.length;

            // 显示同步间隔
            const interval = data.sync_interval || 60;
            document.getElementById('sync-interval').textContent = `每 ${interval} 分钟`;

            if (subscriptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            <i class="fas fa-rss"></i>
                            <p>暂无订阅</p>
                            <p class="text-sm mt-2">同步歌单后会自动添加订阅</p>
                        </td>
                    </tr>`;
                return;
            }

            tbody.innerHTML = subscriptions.map(sub => {
                const platformIcons = {
                    'NCM': '<i class="fas fa-cloud text-red-400"></i>',
                    'QQ': '<i class="fab fa-qq text-green-400"></i>',
                    'Spotify': '<i class="fab fa-spotify text-green-500"></i>'
                };
                const platformNames = {
                    'NCM': '网易云',
                    'QQ': 'QQ音乐',
                    'Spotify': 'Spotify'
                };
                const platformIcon = platformIcons[sub.platform] || '<i class="fas fa-music"></i>';
                const platformName = platformNames[sub.platform] || sub.platform;

                const lastSync = sub.last_sync_at
                    ? new Date(sub.last_sync_at + 'Z').toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' })
                    : '从未同步';

                const statusClass = sub.is_active ? 'text-green-400' : 'text-gray-500';
                const statusText = sub.is_active ? '启用' : '禁用';
                const statusIcon = sub.is_active ? 'fa-check-circle' : 'fa-pause-circle';
                const toggleText = sub.is_active ? '禁用' : '启用';
                const toggleClass = sub.is_active ? 'btn-secondary' : 'btn-primary';

                // 可见性 UI
                const isPublic = sub.is_public !== false; // 默认为 true
                const visibilityClass = isPublic ? 'text-blue-400' : 'text-orange-400';
                const visibilityText = isPublic ? '公开' : '私有';
                const visibilityIcon = isPublic ? 'fa-globe' : 'fa-lock';
                const visibilityBtnClass = isPublic ? 'bg-orange-600 hover:bg-orange-700' : 'bg-blue-600 hover:bg-blue-700';
                const visibilityBtnText = isPublic ? '设为私有' : '设为公开';

                return `
                <tr>
                    <td>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center">
                                <i class="fas fa-list-music text-white"></i>
                            </div>
                            <div>
                                <p class="font-medium">${sub.playlist_name || '未命名歌单'}</p>
                                <p class="text-xs text-gray-500">用户: ${sub.telegram_id}</p>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="flex items-center gap-2">
                            ${platformIcon}
                            <span>${platformName}</span>
                        </span>
                    </td>
                    <td>
                        <span class="text-lg font-semibold">${sub.song_count}</span>
                        <span class="text-gray-500 text-sm">首</span>
                    </td>
                    <td class="text-gray-500 text-sm">${lastSync}</td>
                    <td>
                        <span class="${visibilityClass}">
                            <i class="fas ${visibilityIcon} mr-1"></i>${visibilityText}
                        </span>
                    </td>
                    <td>
                        <span class="${statusClass}">
                            <i class="fas ${statusIcon} mr-1"></i>${statusText}
                        </span>
                    </td>
                    <td>
                        <div class="flex gap-2">
                            <button onclick="toggleVisibility(${sub.id})" class="px-3 py-1 rounded text-white text-xs ${visibilityBtnClass} transition-colors">
                                ${visibilityBtnText}
                            </button>
                            <button onclick="toggleSubscription(${sub.id})" class="${toggleClass}" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                ${toggleText}
                            </button>
                            <button onclick="deleteSubscription(${sub.id}, '${sub.playlist_name}')" class="btn-danger" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        } catch (e) {
            console.error('加载失败:', e);
            document.getElementById('subscription-table').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-red-400 py-12">
                        <i class="fas fa-exclamation-triangle mr-2"></i>加载失败: ${e.message}
                    </td>
                </tr>`;
        }
    }

    async function toggleVisibility(id) {
        try {
            const res = await fetch(`/api/subscriptions/${id}/toggle_visibility`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'ok') {
                loadSubscriptions();
            } else {
                alert('操作失败: ' + (data.message || '未知错误'));
            }
        } catch (e) {
            alert('操作失败: ' + e.message);
        }
    }

    async function toggleSubscription(id) {
        try {
            const res = await fetch(`/api/subscriptions/${id}/toggle`, { method: 'POST' });
            const data = await res.json();
            if (data.status === 'ok') {
                loadSubscriptions();
            } else {
                alert('操作失败: ' + (data.message || '未知错误'));
            }
        } catch (e) {
            alert('操作失败: ' + e.message);
        }
    }

    async function deleteSubscription(id, name) {
        if (!confirm(`确定要删除订阅「${name}」吗？\n\n删除后将不再自动检查该歌单的更新。`)) return;

        try {
            const res = await fetch(`/api/subscriptions/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadSubscriptions();
            } else {
                const data = await res.json();
                alert('删除失败: ' + (data.detail || '未知错误'));
            }
        } catch (e) {
            alert('删除失败: ' + e.message);
        }
    }

    loadSubscriptions();
</script>
{% endblock %}