{% extends "base.html" %}

{% block title %}卡密管理 - TGmusicbot{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold">卡密管理</h1>
            <p class="text-gray-500 mt-1">生成和管理会员卡密</p>
        </div>
        <div class="flex gap-2">
            <button onclick="showGenerateModal()" class="btn-primary">
                <i class="fas fa-plus mr-2"></i>生成卡密
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div class="stat-card blue p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">总卡密</p>
                    <p class="stat-value" id="stat-total">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
            </div>
        </div>
        <div class="stat-card green p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">未使用</p>
                    <p class="stat-value" id="stat-unused">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
            </div>
        </div>
        <div class="stat-card purple p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">已使用</p>
                    <p class="stat-value" id="stat-used">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-user-check"></i></div>
            </div>
        </div>
    </div>

    <!-- 筛选 -->
    <div class="glass-card p-4 mb-4 flex gap-4 items-center">
        <select id="status-filter" class="select-modern" onchange="filterCards()">
            <option value="">全部状态</option>
            <option value="unused">未使用</option>
            <option value="used">已使用</option>
        </select>
        <button onclick="refreshData()" class="pagination-btn"><i class="fas fa-sync-alt"></i></button>
    </div>

    <!-- 卡密列表 -->
    <div class="glass-card p-6">
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>卡密</th>
                        <th>天数</th>
                        <th>状态</th>
                        <th>使用者</th>
                        <th>使用时间</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="cards-list">
                    <tr>
                        <td colspan="7" class="text-center text-gray-500 py-8">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-500">
                共 <span id="total-count">0</span> 条记录
            </div>
            <div class="flex gap-2">
                <button id="prev-btn" class="pagination-btn" onclick="prevPage()" disabled>上一页</button>
                <span class="px-4 py-2 text-gray-400">第 <span id="current-page">1</span> 页</span>
                <button id="next-btn" class="pagination-btn" onclick="nextPage()">下一页</button>
            </div>
        </div>
    </div>
</div>

<!-- 生成弹窗 -->
<div id="generate-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-card p-6 w-96">
        <h3 class="text-lg font-bold mb-4">生成卡密</h3>
        <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2">生成数量</label>
            <input type="number" id="gen-count"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" value="10" min="1"
                max="100">
        </div>
        <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2">有效天数</label>
            <input type="number" id="gen-days"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" value="30" min="1">
        </div>
        <div class="flex gap-2">
            <button onclick="closeGenerateModal()"
                class="flex-1 px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700">取消</button>
            <button onclick="generateCards()" class="flex-1 btn-primary">生成</button>
        </div>
    </div>
</div>

<!-- 生成结果弹窗 -->
<div id="result-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-card p-6 w-full max-w-lg">
        <h3 class="text-lg font-bold mb-4">生成成功</h3>
        <div class="mb-4">
            <textarea id="result-cards"
                class="w-full h-64 bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white font-mono text-sm"
                readonly></textarea>
        </div>
        <div class="flex gap-2">
            <button onclick="copyCards()"
                class="flex-1 px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700"><i
                    class="fas fa-copy mr-2"></i>复制</button>
            <button onclick="closeResultModal()" class="flex-1 btn-primary">关闭</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const perPage = 20;
    let totalCards = 0;

    async function loadCards(page = 1) {
        const status = document.getElementById('status-filter').value;
        const url = `/api/admin/cards?page=${page}&per_page=${perPage}${status ? '&status=' + status : ''}`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            if (data.code === 200) {
                totalCards = data.total;
                currentPage = page;
                renderCards(data.cards);
                updatePagination(data);
                updateStats();
            }
        } catch (err) {
            console.error('加载失败:', err);
        }
    }

    function renderCards(cards) {
        const tbody = document.getElementById('cards-list');

        if (!cards.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-8">暂无数据</td></tr>';
            return;
        }

        tbody.innerHTML = cards.map(c => `
            <tr>
                <td>
                    <code class="bg-gray-800 px-2 py-1 rounded text-sm">${c.card_key}</code>
                </td>
                <td><span class="text-green-400 font-medium">${c.duration_days} 天</span></td>
                <td>
                    ${c.status === 'unused'
                ? '<span class="badge badge-qq">未使用</span>'
                : '<span class="badge badge-ncm">已使用</span>'}
                </td>
                <td>${c.used_by_username || '-'}</td>
                <td>${c.used_at ? formatDate(c.used_at) : '-'}</td>
                <td>${formatDate(c.created_at)}</td>
                <td>
                    <button onclick="copyToClipboard('${c.card_key}')" class="px-2 py-1 text-xs bg-blue-600 bg-opacity-20 text-blue-400 rounded hover:bg-opacity-40" title="复制">
                        <i class="fas fa-copy"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    async function updateStats() {
        // 简单统计
        const allRes = await fetch('/api/admin/cards?page=1&per_page=1');
        const allData = await allRes.json();
        document.getElementById('stat-total').textContent = allData.total || 0;

        const unusedRes = await fetch('/api/admin/cards?page=1&per_page=1&status=unused');
        const unusedData = await unusedRes.json();
        document.getElementById('stat-unused').textContent = unusedData.total || 0;

        const usedRes = await fetch('/api/admin/cards?page=1&per_page=1&status=used');
        const usedData = await usedRes.json();
        document.getElementById('stat-used').textContent = usedData.total || 0;
    }

    function updatePagination(data) {
        document.getElementById('total-count').textContent = data.total;
        document.getElementById('current-page').textContent = data.page;
        document.getElementById('prev-btn').disabled = data.page <= 1;
        document.getElementById('next-btn').disabled = data.page * perPage >= data.total;
    }

    function prevPage() { if (currentPage > 1) loadCards(currentPage - 1); }
    function nextPage() { loadCards(currentPage + 1); }
    function refreshData() { loadCards(currentPage); }
    function filterCards() { loadCards(1); }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('zh-CN');
    }

    function showGenerateModal() {
        document.getElementById('generate-modal').classList.remove('hidden');
    }

    function closeGenerateModal() {
        document.getElementById('generate-modal').classList.add('hidden');
    }

    async function generateCards() {
        const count = parseInt(document.getElementById('gen-count').value);
        const days = parseInt(document.getElementById('gen-days').value);

        try {
            const res = await fetch('/api/admin/cards/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ count, duration_days: days })
            });
            const data = await res.json();

            if (data.code === 200) {
                closeGenerateModal();
                document.getElementById('result-cards').value = data.cards.join('\n');
                document.getElementById('result-modal').classList.remove('hidden');
                loadCards(1);
            } else {
                alert(data.message || '生成失败');
            }
        } catch (err) {
            alert('生成失败');
        }
    }

    function closeResultModal() {
        document.getElementById('result-modal').classList.add('hidden');
    }

    function copyCards() {
        const textarea = document.getElementById('result-cards');
        textarea.select();
        document.execCommand('copy');
        alert('已复制到剪贴板');
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('已复制: ' + text);
        });
    }

    // 初始化
    loadCards();
</script>
{% endblock %}