{% extends "base.html" %}

{% block title %}歌曲申请 - TGmusicbot{% endblock %}

{% block content %}
<div class="mb-8 animate-fade-in">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold">歌曲补全申请</h1>
            <p class="text-gray-500 mt-1">用户提交的歌曲下载请求</p>
        </div>
        <div class="flex items-center gap-3">
            <select id="status-filter" class="select-modern" onchange="loadRequests()">
                <option value="">全部状态</option>
                <option value="pending">待审核</option>
                <option value="approved">已批准</option>
                <option value="rejected">已拒绝</option>
            </select>
        </div>
    </div>
</div>

<div class="glass-card p-6 animate-fade-in delay-1">
    <div class="overflow-x-auto">
        <table class="data-table">
            <thead>
                <tr>
                    <th>用户 ID</th>
                    <th>歌曲信息</th>
                    <th>来源链接</th>
                    <th>状态</th>
                    <th>申请时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="requests-table">
                <tr>
                    <td colspan="6" class="text-center py-8 text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>加载中...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 审核弹窗 -->
<div id="review-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="closeModal(event)">
    <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-md border border-gray-700" onclick="event.stopPropagation()">
        <h3 class="text-xl font-bold mb-4" id="modal-title">审核申请</h3>
        <div id="modal-info" class="mb-4 p-4 bg-gray-800 rounded-lg">
            <p class="text-sm text-gray-400">歌曲: <span id="modal-song" class="text-white"></span></p>
            <p class="text-sm text-gray-400">艺术家: <span id="modal-artist" class="text-white"></span></p>
        </div>
        <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2">备注（可选）</label>
            <textarea id="modal-note" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white resize-none" rows="3" placeholder="给用户的反馈信息..."></textarea>
        </div>
        <div class="flex gap-3">
            <button onclick="submitReview('approve')" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg transition">
                <i class="fas fa-check mr-2"></i>批准
            </button>
            <button onclick="submitReview('reject')" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg transition">
                <i class="fas fa-times mr-2"></i>拒绝
            </button>
            <button onclick="closeModal()" class="px-4 bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg transition">
                取消
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentRequestId = null;

async function loadRequests() {
    const status = document.getElementById('status-filter').value;
    const url = status ? `/api/requests?status=${status}` : '/api/requests';
    
    try {
        const res = await fetch(url);
        if (res.status === 401) {
            window.location.href = '/login';
            return;
        }
        const data = await res.json();
        renderRequests(data);
    } catch (err) {
        console.error(err);
    }
}

function renderRequests(requests) {
    const tbody = document.getElementById('requests-table');
    
    if (!requests.length) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="empty-state">
                    <i class="fas fa-inbox"></i>
                    <p>暂无申请记录</p>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = requests.map(r => `
        <tr>
            <td><code class="text-xs bg-gray-800 px-2 py-1 rounded">${r.telegram_id}</code></td>
            <td>
                <div class="font-medium">${escapeHtml(r.song_name)}</div>
                ${r.artist ? `<div class="text-sm text-gray-500">${escapeHtml(r.artist)}</div>` : ''}
                ${r.album ? `<div class="text-xs text-gray-600">专辑: ${escapeHtml(r.album)}</div>` : ''}
            </td>
            <td>
                ${r.source_url ? `<a href="${escapeHtml(r.source_url)}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm">
                    <i class="fas fa-external-link-alt mr-1"></i>查看
                </a>` : '<span class="text-gray-600">无</span>'}
            </td>
            <td>${getStatusBadge(r.status)}</td>
            <td class="text-sm text-gray-400">${formatDate(r.created_at)}</td>
            <td>
                ${r.status === 'pending' ? `
                    <button onclick="openReviewModal(${r.id}, '${escapeHtml(r.song_name)}', '${escapeHtml(r.artist || '')}')" 
                            class="text-blue-400 hover:text-blue-300 mr-3">
                        <i class="fas fa-gavel"></i>
                    </button>
                ` : ''}
                <button onclick="deleteRequest(${r.id})" class="text-red-400 hover:text-red-300">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge" style="background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3);">待审核</span>',
        'approved': '<span class="badge" style="background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3);">已批准</span>',
        'rejected': '<span class="badge" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3);">已拒绝</span>'
    };
    return badges[status] || status;
}

function formatDate(dateStr) {
    return new Date(dateStr).toLocaleString('zh-CN', {
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
    });
}

function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function openReviewModal(id, song, artist) {
    currentRequestId = id;
    document.getElementById('modal-song').textContent = song;
    document.getElementById('modal-artist').textContent = artist || '未知';
    document.getElementById('modal-note').value = '';
    document.getElementById('review-modal').classList.remove('hidden');
    document.getElementById('review-modal').classList.add('flex');
}

function closeModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('review-modal').classList.add('hidden');
    document.getElementById('review-modal').classList.remove('flex');
    currentRequestId = null;
}

async function submitReview(action) {
    if (!currentRequestId) return;
    
    const note = document.getElementById('modal-note').value;
    const url = action === 'approve' 
        ? `/api/requests/${currentRequestId}/approve`
        : `/api/requests/${currentRequestId}/reject`;
    
    try {
        const formData = new FormData();
        formData.append('note', note);
        
        const res = await fetch(url, {
            method: 'POST',
            body: formData
        });
        
        if (res.ok) {
            closeModal();
            loadRequests();
        } else {
            alert('操作失败');
        }
    } catch (err) {
        alert('网络错误');
    }
}

async function deleteRequest(id) {
    if (!confirm('确定要删除这条申请吗？')) return;
    
    try {
        const res = await fetch(`/api/requests/${id}`, { method: 'DELETE' });
        if (res.ok) {
            loadRequests();
        }
    } catch (err) {
        alert('删除失败');
    }
}

// 初始加载
loadRequests();
</script>
{% endblock %}
