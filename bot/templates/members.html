{% extends "base.html" %}

{% block title %}用户管理 - TGmusicbot{% endblock %}

{% block content %}
<div class="animate-fade-in">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold">用户管理</h1>
            <p class="text-gray-500 mt-1">管理注册用户和会员状态</p>
        </div>
        <div class="flex gap-2">
            <button onclick="refreshData()" class="btn-primary">
                <i class="fas fa-sync-alt mr-2"></i>刷新
            </button>
        </div>
    </div>

    <!-- 统计卡片 -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div class="stat-card blue p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">总用户</p>
                    <p class="stat-value" id="stat-total">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-users"></i></div>
            </div>
        </div>
        <div class="stat-card green p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">活跃会员</p>
                    <p class="stat-value" id="stat-active">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-crown"></i></div>
            </div>
        </div>
        <div class="stat-card purple p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">已过期</p>
                    <p class="stat-value" id="stat-expired">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-clock"></i></div>
            </div>
        </div>
        <div class="stat-card orange p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-sm">未开通</p>
                    <p class="stat-value" id="stat-none">0</p>
                </div>
                <div class="stat-icon"><i class="fas fa-user-plus"></i></div>
            </div>
        </div>
    </div>

    <!-- 用户列表 -->
    <div class="glass-card p-6">
        <div class="overflow-x-auto">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>用户名</th>
                        <th>Telegram</th>
                        <th>Emby</th>
                        <th>积分</th>
                        <th>会员状态</th>
                        <th>到期时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="members-list">
                    <tr>
                        <td colspan="8" class="text-center text-gray-500 py-8">加载中...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <div class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-500">
                共 <span id="total-count">0</span> 条记录
            </div>
            <div class="flex gap-2">
                <button id="prev-btn" class="pagination-btn" onclick="prevPage()" disabled>上一页</button>
                <span class="px-4 py-2 text-gray-400">第 <span id="current-page">1</span> 页</span>
                <button id="next-btn" class="pagination-btn" onclick="nextPage()">下一页</button>
            </div>
        </div>
    </div>
</div>

<!-- 赠送弹窗 -->
<div id="gift-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="glass-card p-6 w-96">
        <h3 class="text-lg font-bold mb-4" id="gift-title">赠送</h3>
        <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2" id="gift-label">数量</label>
            <input type="number" id="gift-amount"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" value="10" min="1">
        </div>
        <div class="mb-4">
            <label class="block text-gray-400 text-sm mb-2">备注</label>
            <input type="text" id="gift-reason"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white" placeholder="管理员赠送">
        </div>
        <div class="flex gap-2">
            <button onclick="closeGiftModal()"
                class="flex-1 px-4 py-2 border border-gray-600 rounded-lg hover:bg-gray-700">取消</button>
            <button onclick="submitGift()" class="flex-1 btn-primary">确认赠送</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    const perPage = 20;
    let totalMembers = 0;
    let giftType = '';
    let giftUserId = 0;

    async function loadMembers(page = 1) {
        try {
            const res = await fetch(`/api/admin/members?page=${page}&per_page=${perPage}`);
            const data = await res.json();

            if (data.code === 200) {
                totalMembers = data.total;
                currentPage = page;
                renderMembers(data.members);
                updatePagination(data);
                updateStats(data.members);
            }
        } catch (err) {
            console.error('加载失败:', err);
        }
    }

    function renderMembers(members) {
        const tbody = document.getElementById('members-list');

        if (!members.length) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500 py-8">暂无数据</td></tr>';
            return;
        }

        tbody.innerHTML = members.map(m => {
            // Telegram 显示
            const tgHtml = m.telegram_id
                ? `<code class="text-xs bg-blue-900 bg-opacity-30 px-2 py-1 rounded">${m.telegram_id}</code>`
                : '<span class="text-gray-500 text-xs">未绑定</span>';
            // Emby 显示
            const embyHtml = m.emby_username
                ? `<span class="text-green-400 text-xs"><i class="fas fa-check-circle mr-1"></i>${m.emby_username}</span>`
                : '<span class="text-gray-500 text-xs">未绑定</span>';
            return `
            <tr>
                <td>${m.id}</td>
                <td>
                    <div class="font-medium">${m.username}</div>
                    <div class="text-xs text-gray-500">${m.role === 'admin' ? '管理员' : '普通用户'}</div>
                </td>
                <td>${tgHtml}</td>
                <td>${embyHtml}</td>
                <td><span class="text-purple-400 font-medium">${m.points}</span></td>
                <td>
                    ${m.is_member ? '<span class="badge badge-qq">正常</span>' :
                    (m.expire_at ? '<span class="badge badge-ncm">已过期</span>' : '<span class="badge" style="background:rgba(156,163,175,0.2);color:#9ca3af;border:1px solid rgba(156,163,175,0.3)">未开通</span>')}
                </td>
                <td>${m.expire_at ? formatDate(m.expire_at) : '-'}</td>
                <td>
                    <div class="flex gap-1 flex-wrap">
                        <button onclick="giftPoints(${m.id})" class="px-2 py-1 text-xs bg-purple-600 bg-opacity-20 text-purple-400 rounded hover:bg-opacity-40" title="赠送积分">
                            <i class="fas fa-coins"></i>
                        </button>
                        <button onclick="giftDays(${m.id})" class="px-2 py-1 text-xs bg-green-600 bg-opacity-20 text-green-400 rounded hover:bg-opacity-40" title="赠送天数">
                            <i class="fas fa-calendar-plus"></i>
                        </button>
                        <button onclick="toggleMember(${m.id}, ${m.is_active})" class="px-2 py-1 text-xs ${m.is_active ? 'bg-orange-600 bg-opacity-20 text-orange-400' : 'bg-green-600 bg-opacity-20 text-green-400'} rounded hover:bg-opacity-40" title="${m.is_active ? '禁用' : '启用'}">
                            <i class="fas fa-${m.is_active ? 'ban' : 'check'}"></i>
                        </button>
                        <button onclick="deleteMember(${m.id}, '${m.username}')" class="px-2 py-1 text-xs bg-red-600 bg-opacity-20 text-red-400 rounded hover:bg-opacity-40" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `}).join('');
    }

    function updateStats(members) {
        const total = totalMembers;
        const active = members.filter(m => m.is_member).length;
        const expired = members.filter(m => !m.is_member && m.expire_at).length;
        const none = members.filter(m => !m.expire_at).length;

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-active').textContent = active;
        document.getElementById('stat-expired').textContent = expired;
        document.getElementById('stat-none').textContent = none;
    }

    function updatePagination(data) {
        document.getElementById('total-count').textContent = data.total;
        document.getElementById('current-page').textContent = data.page;
        document.getElementById('prev-btn').disabled = data.page <= 1;
        document.getElementById('next-btn').disabled = data.page >= data.total_pages;
    }

    function prevPage() { if (currentPage > 1) loadMembers(currentPage - 1); }
    function nextPage() { loadMembers(currentPage + 1); }
    function refreshData() { loadMembers(currentPage); }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        return new Date(dateStr).toLocaleDateString('zh-CN');
    }

    function giftPoints(userId) {
        giftType = 'points';
        giftUserId = userId;
        document.getElementById('gift-title').textContent = '赠送积分';
        document.getElementById('gift-label').textContent = '积分数量';
        document.getElementById('gift-amount').value = 100;
        document.getElementById('gift-modal').classList.remove('hidden');
    }

    function giftDays(userId) {
        giftType = 'days';
        giftUserId = userId;
        document.getElementById('gift-title').textContent = '赠送会员天数';
        document.getElementById('gift-label').textContent = '天数';
        document.getElementById('gift-amount').value = 30;
        document.getElementById('gift-modal').classList.remove('hidden');
    }

    function closeGiftModal() {
        document.getElementById('gift-modal').classList.add('hidden');
    }

    async function submitGift() {
        const amount = parseInt(document.getElementById('gift-amount').value);
        const reason = document.getElementById('gift-reason').value || '管理员赠送';

        const endpoint = giftType === 'points'
            ? `/api/admin/members/${giftUserId}/gift-points`
            : `/api/admin/members/${giftUserId}/gift-days`;

        const body = giftType === 'points'
            ? { points: amount, reason: reason }
            : { days: amount, reason: reason };

        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            alert(data.message);
            closeGiftModal();
            loadMembers(currentPage);
        } catch (err) {
            alert('操作失败');
        }
    }

    async function toggleMember(userId, isActive) {
        if (!confirm(isActive ? '确定要禁用此用户吗？' : '确定要启用此用户吗？')) return;

        try {
            const res = await fetch(`/api/admin/members/${userId}/toggle`, { method: 'POST' });
            const data = await res.json();
            alert(data.message);
            loadMembers(currentPage);
        } catch (err) {
            alert('操作失败');
        }
    }

    async function deleteMember(userId, username) {
        if (!confirm(`确定要删除用户 ${username} 吗？\n\n此操作不可恢复！`)) return;

        try {
            const res = await fetch(`/api/users/${userId}`, { method: 'DELETE' });
            if (res.ok) {
                alert('删除成功');
                loadMembers(currentPage);
            } else {
                const data = await res.json();
                alert(data.detail || '删除失败');
            }
        } catch (err) {
            alert('删除失败: ' + err.message);
        }
    }

    // 初始化
    loadMembers();
</script>
{% endblock %}