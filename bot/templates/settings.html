{% extends "base.html" %}

{% block title %}系统设置 - TGmusicbot{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-2xl font-bold mb-1">系统设置</h2>
    <p class="text-gray-500">查看系统配置和运行状态</p>
</div>

<!-- 服务状态 -->
<div class="glass-card p-6 mb-6">
    <h3 class="font-semibold mb-6 flex items-center gap-2">
        <i class="fas fa-heartbeat text-red-400"></i>
        服务状态
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5">
            <div class="w-12 h-12 rounded-xl bg-green-500 bg-opacity-20 flex items-center justify-center">
                <i class="fab fa-telegram text-green-400 text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-400">Telegram Bot</p>
                <p class="font-semibold text-green-400">
                    <i class="fas fa-circle text-xs mr-1"></i>运行中
                </p>
            </div>
        </div>
        
        <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5">
            <div class="w-12 h-12 rounded-xl bg-blue-500 bg-opacity-20 flex items-center justify-center">
                <i class="fas fa-server text-blue-400 text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-400">Web 服务</p>
                <p class="font-semibold text-green-400">
                    <i class="fas fa-circle text-xs mr-1"></i>运行中
                </p>
            </div>
        </div>
        
        <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5" id="emby-status">
            <div class="w-12 h-12 rounded-xl bg-purple-500 bg-opacity-20 flex items-center justify-center">
                <i class="fas fa-film text-purple-400 text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-400">Emby 连接</p>
                <p class="font-semibold text-gray-400">
                    <i class="fas fa-spinner fa-spin text-xs mr-1"></i>检测中...
                </p>
            </div>
        </div>
        
        <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5" id="ncm-status">
            <div class="w-12 h-12 rounded-xl bg-red-500 bg-opacity-20 flex items-center justify-center">
                <i class="fas fa-cloud-download-alt text-red-400 text-xl"></i>
            </div>
            <div>
                <p class="text-sm text-gray-400">网易云下载</p>
                <p class="font-semibold text-gray-400">
                    <i class="fas fa-spinner fa-spin text-xs mr-1"></i>检测中...
                </p>
            </div>
        </div>
    </div>
</div>

<!-- 网易云音乐配置 -->
<div class="glass-card p-6 mb-6">
    <h3 class="font-semibold mb-6 flex items-center gap-2">
        <i class="fas fa-cloud text-red-400"></i>
        网易云音乐自动下载
    </h3>
    
    <div id="ncm-config-status" class="mb-6 p-4 rounded-xl bg-white bg-opacity-5">
        <div class="flex items-center gap-4">
            <div id="ncm-avatar" class="w-16 h-16 rounded-full bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center text-2xl">
                <i class="fas fa-user"></i>
            </div>
            <div class="flex-1">
                <p class="text-lg font-semibold" id="ncm-nickname">未登录</p>
                <p class="text-sm text-gray-400" id="ncm-vip-status">请配置网易云账号</p>
            </div>
            <div id="ncm-login-buttons" class="flex gap-2">
                <button id="btn-qr-login" class="btn-primary">
                    <i class="fas fa-qrcode mr-2"></i>扫码登录
                </button>
                <button id="btn-cookie-login" class="btn-secondary" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 10px;">
                    <i class="fas fa-key mr-2"></i>Cookie 登录
                </button>
            </div>
            <div id="ncm-logout-buttons" class="hidden flex gap-2">
                <button id="btn-ncm-logout" class="btn-danger">
                    <i class="fas fa-sign-out-alt mr-2"></i>退出登录
                </button>
            </div>
        </div>
    </div>
    
    <!-- Cookie 输入弹窗 -->
    <div id="cookie-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="glass-card p-8 max-w-2xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">手动输入 Cookie</h3>
                <button id="btn-close-cookie" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="mb-4">
                <label class="text-sm text-gray-400 mb-2 block">粘贴你的网易云 MUSIC_U 值</label>
                <div class="flex items-start bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl overflow-hidden focus-within:border-indigo-500">
                    <span class="px-3 py-3 text-sm font-mono text-indigo-400 bg-white bg-opacity-5 border-r border-white border-opacity-10 select-none">MUSIC_U=</span>
                    <textarea id="cookie-input" class="flex-1 h-24 bg-transparent p-3 text-sm font-mono text-gray-300 focus:outline-none resize-none" placeholder="粘贴 MUSIC_U 的值（一串十六进制字符）..."></textarea>
                </div>
                <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>在网易云网页版按 F12 → Console → 输入 document.cookie 查找 MUSIC_U 的值</p>
            </div>
            
            <div class="flex justify-end gap-3">
                <button id="btn-cancel-cookie" class="px-4 py-2 text-gray-400 hover:text-white">取消</button>
                <button id="btn-save-cookie" class="btn-primary">
                    <i class="fas fa-check mr-2"></i>验证并保存
                </button>
            </div>
            
            <div id="cookie-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
        </div>
    </div>
    
    <!-- 扫码登录弹窗 -->
    <div id="qr-login-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="glass-card p-8 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">网易云扫码登录</h3>
                <button id="btn-close-qr" class="text-gray-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="qr-container" class="text-center py-6">
                <div id="qr-loading" class="py-8">
                    <i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i>
                    <p class="mt-4 text-gray-400">正在生成二维码...</p>
                </div>
                <div id="qr-image-container" class="hidden">
                    <img id="qr-image" src="" alt="登录二维码" class="mx-auto w-48 h-48 rounded-xl bg-white p-2">
                    <p id="qr-status" class="mt-4 text-gray-400">请使用网易云音乐 App 扫描二维码</p>
                </div>
                <div id="qr-expired" class="hidden py-8">
                    <i class="fas fa-exclamation-circle text-4xl text-yellow-400"></i>
                    <p class="mt-4 text-gray-400">二维码已过期</p>
                    <button id="btn-refresh-qr" class="btn-primary mt-4">
                        <i class="fas fa-sync-alt mr-2"></i>重新获取
                    </button>
                </div>
                <div id="qr-success" class="hidden py-8">
                    <i class="fas fa-check-circle text-4xl text-green-400"></i>
                    <p class="mt-4 text-green-400 font-semibold">登录成功！</p>
                    <p id="qr-success-name" class="text-gray-400"></p>
                </div>
            </div>
            
            <div class="text-center text-sm text-gray-500 mt-4">
                <p><i class="fas fa-mobile-alt mr-1"></i>打开网易云音乐 App</p>
                <p>侧边栏 → 扫一扫</p>
            </div>
        </div>
    </div>
    
    <!-- 下载设置表单 -->
    <form id="ncm-settings-form" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <label class="text-sm text-gray-400 mb-2 block">下载音质</label>
                <select id="ncm-quality-select" name="ncm_quality" class="select-modern w-full">
                    <option value="standard">标准音质 (128kbps)</option>
                    <option value="higher">较高音质 (192kbps)</option>
                    <option value="exhigh" selected>极高音质 (320kbps)</option>
                    <option value="lossless">无损音质 (FLAC) - 需VIP</option>
                    <option value="hires">Hi-Res - 需VIP</option>
                </select>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>无损和 Hi-Res 需要网易云 VIP 账号
                </p>
            </div>
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <label class="text-sm text-gray-400 mb-2 block">自动下载</label>
                <div class="flex items-center gap-3 mt-2">
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-download-toggle" name="auto_download" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                    </label>
                    <span class="text-sm text-gray-300" id="auto-download-label">未启用</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>同步网易云歌单时显示下载按钮
                </p>
            </div>
        </div>
        
        <!-- 下载目录配置 -->
        <div class="mt-6 p-4 rounded-xl bg-white bg-opacity-5 border border-white border-opacity-10">
            <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-folder-open text-yellow-400"></i>
                下载目录配置
            </h4>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">下载模式</label>
                    <select id="download-mode" name="download_mode" class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500">
                        <option value="local">仅下载到本地目录</option>
                        <option value="musictag">下载后转移到 MusicTag</option>
                    </select>
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">本地下载目录</label>
                    <input type="text" id="download-dir" name="download_dir" class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm font-mono focus:outline-none focus:border-indigo-500" placeholder="/path/to/uploads">
                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>歌曲下载后保存的目录</p>
                </div>
                <div id="musictag-dir-container">
                    <label class="text-sm text-gray-400 mb-2 block">MusicTag 监控目录</label>
                    <input type="text" id="musictag-dir" name="musictag_dir" class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm font-mono focus:outline-none focus:border-indigo-500" placeholder="/path/to/musictag/input">
                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>下载完成后自动移动到此目录，由 MusicTag 刮削整理</p>
                </div>
            </div>
        </div>
        
        <!-- Emby 媒体库扫描 -->
        <div class="mt-6 p-4 rounded-xl bg-white bg-opacity-5 border border-white border-opacity-10">
            <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-sync-alt text-purple-400"></i>
                Emby 媒体库自动扫描
            </h4>
            <div class="space-y-4">
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">扫描间隔（小时）</label>
                    <input type="number" id="emby-scan-interval" name="emby_scan_interval" min="0" class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500" placeholder="0">
                    <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>设为 0 禁用自动扫描。定时从 Emby 同步最新曲库，以便歌单匹配更准确</p>
                </div>
            </div>
        </div>
        
        <div class="flex justify-end gap-4">
            <button type="submit" class="btn-primary">
                <i class="fas fa-save mr-2"></i>保存设置
            </button>
        </div>
    </form>
    
    <div id="save-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
    
    <div class="mt-6 p-4 rounded-xl bg-blue-500 bg-opacity-10 border border-blue-500 border-opacity-30">
        <h4 class="font-semibold text-blue-400 mb-2"><i class="fas fa-lightbulb mr-2"></i>登录方式</h4>
        <div class="text-sm text-gray-300 space-y-2">
            <p><strong class="text-blue-300">方式一：扫码登录（推荐）</strong></p>
            <p class="pl-4">点击上方「扫码登录」按钮，使用网易云 App 扫描即可</p>
            <p class="mt-2"><strong class="text-blue-300">方式二：手动配置 Cookie</strong></p>
            <ol class="pl-4 list-decimal list-inside space-y-1 text-gray-400">
                <li>在浏览器登录 <a href="https://music.163.com" target="_blank" class="text-blue-400 hover:underline">music.163.com</a></li>
                <li>按 F12 打开开发者工具，切换到 Network 标签</li>
                <li>刷新页面，点击任意请求，复制 Headers 中的 Cookie</li>
                <li>添加到 .env 文件的 NCM_COOKIE 配置项</li>
            </ol>
        </div>
    </div>
</div>

<!-- 配置信息 -->
<div class="glass-card p-6 mb-6">
    <h3 class="font-semibold mb-6 flex items-center gap-2">
        <i class="fas fa-cog text-indigo-400"></i>
        系统配置
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="space-y-4">
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <p class="text-sm text-gray-400 mb-1">Emby 服务器</p>
                <p class="font-mono text-sm" id="config-emby-url">--</p>
            </div>
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <p class="text-sm text-gray-400 mb-1">数据目录</p>
                <p class="font-mono text-sm" id="config-data-dir">--</p>
            </div>
        </div>
        <div class="space-y-4">
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <p class="text-sm text-gray-400 mb-1">数据库文件</p>
                <p class="font-mono text-sm" id="config-database">--</p>
            </div>
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <p class="text-sm text-gray-400 mb-1">媒体库缓存</p>
                <p class="font-mono text-sm" id="config-cache">--</p>
            </div>
        </div>
    </div>
</div>

<!-- 关于 -->
<div class="glass-card p-6">
    <h3 class="font-semibold mb-6 flex items-center gap-2">
        <i class="fas fa-info-circle text-cyan-400"></i>
        关于
    </h3>
    <div class="flex items-start gap-6">
        <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
            <i class="fas fa-music text-3xl text-white"></i>
        </div>
        <div>
            <h4 class="text-xl font-bold mb-2">TGmusicbot</h4>
            <p class="text-gray-400 mb-4">版本 2.2.0</p>
            <div class="space-y-2 text-sm text-gray-500">
                <p><i class="fas fa-check text-green-400 mr-2"></i>QQ音乐 / 网易云歌单同步到 Emby</p>
                <p><i class="fas fa-check text-green-400 mr-2"></i>Telegram 音乐文件上传到服务器</p>
                <p><i class="fas fa-check text-green-400 mr-2"></i>网易云缺失歌曲自动下载</p>
                <p><i class="fas fa-check text-green-400 mr-2"></i>NCM 加密格式自动解密</p>
                <p><i class="fas fa-check text-green-400 mr-2"></i>Web 管理界面</p>
                <p><i class="fas fa-check text-green-400 mr-2"></i>多用户支持，独立 Emby 账户绑定</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const autoDownloadToggle = document.getElementById('auto-download-toggle');
    const autoDownloadLabel = document.getElementById('auto-download-label');
    const downloadModeSelect = document.getElementById('download-mode');
    const downloadDirInput = document.getElementById('download-dir');
    const musictagDirInput = document.getElementById('musictag-dir');
    const musictagDirContainer = document.getElementById('musictag-dir-container');
    
    // 登录/退出按钮
    const ncmLoginButtons = document.getElementById('ncm-login-buttons');
    const ncmLogoutButtons = document.getElementById('ncm-logout-buttons');
    const btnNcmLogout = document.getElementById('btn-ncm-logout');
    
    // 扫码登录相关元素
    const qrLoginModal = document.getElementById('qr-login-modal');
    const btnQrLogin = document.getElementById('btn-qr-login');
    const btnCloseQr = document.getElementById('btn-close-qr');
    const btnRefreshQr = document.getElementById('btn-refresh-qr');
    const qrLoading = document.getElementById('qr-loading');
    const qrImageContainer = document.getElementById('qr-image-container');
    const qrImage = document.getElementById('qr-image');
    const qrStatus = document.getElementById('qr-status');
    const qrExpired = document.getElementById('qr-expired');
    const qrSuccess = document.getElementById('qr-success');
    const qrSuccessName = document.getElementById('qr-success-name');
    
    let currentUnikey = null;
    let checkInterval = null;
    
    // 切换开关时更新标签
    autoDownloadToggle.addEventListener('change', function() {
        autoDownloadLabel.textContent = this.checked ? '已启用' : '未启用';
    });
    
    // 下载模式切换时显示/隐藏 MusicTag 目录输入框
    downloadModeSelect.addEventListener('change', function() {
        musictagDirContainer.style.display = this.value === 'musictag' ? 'block' : 'none';
    });
    
    // 根据登录状态显示不同按钮
    function updateLoginButtons(isLoggedIn) {
        if (isLoggedIn) {
            ncmLoginButtons.classList.add('hidden');
            ncmLogoutButtons.classList.remove('hidden');
        } else {
            ncmLoginButtons.classList.remove('hidden');
            ncmLogoutButtons.classList.add('hidden');
        }
    }
    
    // 退出登录
    btnNcmLogout.addEventListener('click', async function() {
        if (!confirm('确定要退出网易云账号吗？')) return;
        
        try {
            const res = await fetch('/api/ncm/logout', { method: 'POST' });
            const data = await res.json();
            
            if (data.status === 'ok') {
                // 刷新页面状态
                loadConfig();
            } else {
                alert('退出失败: ' + (data.message || '未知错误'));
            }
        } catch (e) {
            console.error('退出失败:', e);
            alert('退出失败: ' + e.message);
        }
    });
    
    // 打开扫码登录弹窗
    btnQrLogin.addEventListener('click', function() {
        qrLoginModal.classList.remove('hidden');
        createQrCode();
    });
    
    // 关闭弹窗
    btnCloseQr.addEventListener('click', closeQrModal);
    qrLoginModal.addEventListener('click', function(e) {
        if (e.target === qrLoginModal) closeQrModal();
    });
    
    // 刷新二维码
    btnRefreshQr.addEventListener('click', createQrCode);
    
    function closeQrModal() {
        qrLoginModal.classList.add('hidden');
        if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
        }
    }
    
    function showQrLoading() {
        qrLoading.classList.remove('hidden');
        qrImageContainer.classList.add('hidden');
        qrExpired.classList.add('hidden');
        qrSuccess.classList.add('hidden');
    }
    
    function showQrImage() {
        qrLoading.classList.add('hidden');
        qrImageContainer.classList.remove('hidden');
        qrExpired.classList.add('hidden');
        qrSuccess.classList.add('hidden');
    }
    
    function showQrExpired() {
        qrLoading.classList.add('hidden');
        qrImageContainer.classList.add('hidden');
        qrExpired.classList.remove('hidden');
        qrSuccess.classList.add('hidden');
    }
    
    function showQrSuccess(nickname) {
        qrLoading.classList.add('hidden');
        qrImageContainer.classList.add('hidden');
        qrExpired.classList.add('hidden');
        qrSuccess.classList.remove('hidden');
        qrSuccessName.textContent = '欢迎，' + nickname;
    }
    
    async function createQrCode() {
        showQrLoading();
        if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
        }
        
        try {
            const res = await fetch('/api/ncm/qr/create', { method: 'POST' });
            const data = await res.json();
            
            if (data.status === 'ok') {
                currentUnikey = data.unikey;
                qrImage.src = data.qr_img;
                qrStatus.textContent = '请使用网易云音乐 App 扫描二维码';
                qrStatus.className = 'mt-4 text-gray-400';
                showQrImage();
                
                // 开始轮询检查状态
                startCheckingQr();
            } else {
                qrStatus.textContent = '生成二维码失败: ' + (data.message || '未知错误');
                qrStatus.className = 'mt-4 text-red-400';
                showQrImage();
            }
        } catch (e) {
            console.error('创建二维码失败:', e);
            qrStatus.textContent = '网络错误，请重试';
            qrStatus.className = 'mt-4 text-red-400';
            showQrImage();
        }
    }
    
    function startCheckingQr() {
        checkInterval = setInterval(async () => {
            if (!currentUnikey) return;
            
            try {
                const formData = new FormData();
                formData.append('unikey', currentUnikey);
                
                const res = await fetch('/api/ncm/qr/check', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                
                console.log('[QR Check] 响应:', data);
                
                switch (data.code) {
                    case 801:
                        qrStatus.textContent = '等待扫描...';
                        qrStatus.className = 'mt-4 text-gray-400';
                        break;
                    case 802:
                        qrStatus.textContent = '已扫描，请在手机上确认登录';
                        qrStatus.className = 'mt-4 text-blue-400 animate-pulse';
                        break;
                    case 803:
                        // 登录成功
                        console.log('[QR Check] 登录成功! cookie_saved:', data.cookie_saved);
                        clearInterval(checkInterval);
                        checkInterval = null;
                        
                        // Cookie 已在后端自动保存
                        showQrSuccess(data.nickname || '用户');
                        
                        // 2秒后关闭弹窗并刷新页面
                        setTimeout(() => {
                            closeQrModal();
                            loadConfig();
                        }, 2000);
                        break;
                    case 800:
                        // 二维码过期
                        clearInterval(checkInterval);
                        checkInterval = null;
                        showQrExpired();
                        break;
                    default:
                        console.log('[QR Check] 未知状态码:', data.code, data.message);
                        if (data.status === 'error') {
                            qrStatus.textContent = data.message || '发生错误';
                            qrStatus.className = 'mt-4 text-red-400';
                        }
                }
            } catch (e) {
                console.error('检查二维码状态失败:', e);
            }
        }, 1500);  // 每 1.5 秒检查一次，加快响应速度
    }
    
    async function saveCookie(cookie) {
        try {
            const formData = new FormData();
            formData.append('cookie', cookie);
            
            await fetch('/api/ncm/cookie/save', {
                method: 'POST',
                body: formData
            });
        } catch (e) {
            console.error('保存 Cookie 失败:', e);
        }
    }
    
    async function loadConfig() {
        try {
            const res = await fetch('/api/config');
            const data = await res.json();
            
            document.getElementById('config-emby-url').textContent = data.emby_url || '未配置';
            document.getElementById('config-data-dir').textContent = data.data_dir;
            document.getElementById('config-database').textContent = data.database;
            
            const cacheEl = document.getElementById('config-cache');
            if (data.cache_exists) {
                cacheEl.innerHTML = '<span class="text-green-400"><i class="fas fa-check-circle mr-1"></i>已缓存</span>';
            } else {
                cacheEl.innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle mr-1"></i>未缓存</span>';
            }
            
            // Emby 状态
            const embyStatus = document.getElementById('emby-status');
            if (data.emby_url) {
                embyStatus.querySelector('p:last-child').innerHTML = '<span class="text-green-400"><i class="fas fa-circle text-xs mr-1"></i>已连接</span>';
            } else {
                embyStatus.querySelector('p:last-child').innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle text-xs mr-1"></i>未配置</span>';
            }
            
            // 网易云状态
            const ncmStatus = document.getElementById('ncm-status');
            const ncmNickname = document.getElementById('ncm-nickname');
            const ncmVipStatus = document.getElementById('ncm-vip-status');
            
            if (data.ncm_status) {
                if (data.ncm_status.logged_in) {
                    ncmStatus.querySelector('p:last-child').innerHTML = '<span class="text-green-400"><i class="fas fa-circle text-xs mr-1"></i>已登录</span>';
                    ncmNickname.textContent = data.ncm_status.nickname || '网易云用户';
                    ncmVipStatus.innerHTML = data.ncm_status.is_vip 
                        ? '<span class="text-yellow-400"><i class="fas fa-crown mr-1"></i>VIP 会员</span>'
                        : '<span class="text-gray-400">普通用户</span>';
                    updateLoginButtons(true);
                } else if (data.ncm_status.configured) {
                    ncmStatus.querySelector('p:last-child').innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle text-xs mr-1"></i>Cookie 失效</span>';
                    ncmNickname.textContent = 'Cookie 已过期';
                    ncmVipStatus.textContent = '请重新获取 Cookie';
                    updateLoginButtons(false);
                } else {
                    ncmStatus.querySelector('p:last-child').innerHTML = '<span class="text-gray-400"><i class="fas fa-times-circle text-xs mr-1"></i>未配置</span>';
                    ncmNickname.textContent = '未登录';
                    ncmVipStatus.textContent = '请配置网易云账号';
                    updateLoginButtons(false);
                }
            } else {
                updateLoginButtons(false);
            }
            
            // 设置表单值
            document.getElementById('ncm-quality-select').value = data.ncm_quality || 'exhigh';
            autoDownloadToggle.checked = data.auto_download;
            autoDownloadLabel.textContent = data.auto_download ? '已启用' : '未启用';
            
            // 设置下载目录配置
            downloadModeSelect.value = data.download_mode || 'local';
            downloadDirInput.value = data.download_dir || '';
            musictagDirInput.value = data.musictag_dir || '';
            musictagDirContainer.style.display = downloadModeSelect.value === 'musictag' ? 'block' : 'none';
            
            // 设置 Emby 扫描间隔
            document.getElementById('emby-scan-interval').value = data.emby_scan_interval || 0;
            
        } catch (e) {
            console.error('加载配置失败:', e);
            updateLoginButtons(false);
        }
    }
    
    // 保存设置
    document.getElementById('ncm-settings-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        formData.append('ncm_quality', document.getElementById('ncm-quality-select').value);
        formData.append('auto_download', autoDownloadToggle.checked);
        formData.append('download_mode', downloadModeSelect.value);
        formData.append('download_dir', downloadDirInput.value);
        formData.append('musictag_dir', musictagDirInput.value);
        formData.append('emby_scan_interval', document.getElementById('emby-scan-interval').value);
        
        const saveStatus = document.getElementById('save-status');
        
        try {
            const res = await fetch('/api/settings/ncm', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.status === 'ok') {
                saveStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-green-500 bg-opacity-20 text-green-400 border border-green-500 border-opacity-30';
                saveStatus.innerHTML = '<i class="fas fa-check-circle mr-2"></i>设置已保存';
            } else {
                saveStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
                saveStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>' + (data.message || '保存失败');
            }
            saveStatus.classList.remove('hidden');
            
            setTimeout(() => {
                saveStatus.classList.add('hidden');
            }, 3000);
            
        } catch (e) {
            console.error('保存失败:', e);
            saveStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
            saveStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>保存失败: ' + e.message;
            saveStatus.classList.remove('hidden');
        }
    });

    // ==================== Cookie 手动登录 ====================
    const cookieLoginModal = document.getElementById('cookie-login-modal');
    const btnCookieLogin = document.getElementById('btn-cookie-login');
    const btnCloseCookie = document.getElementById('btn-close-cookie');
    const btnCancelCookie = document.getElementById('btn-cancel-cookie');
    const btnSaveCookie = document.getElementById('btn-save-cookie');
    const cookieInput = document.getElementById('cookie-input');
    const cookieStatus = document.getElementById('cookie-status');
    
    // 打开 Cookie 输入弹窗
    btnCookieLogin.addEventListener('click', function() {
        cookieLoginModal.classList.remove('hidden');
        cookieInput.value = '';
        cookieStatus.classList.add('hidden');
    });
    
    // 关闭弹窗
    function closeCookieModal() {
        cookieLoginModal.classList.add('hidden');
    }
    btnCloseCookie.addEventListener('click', closeCookieModal);
    btnCancelCookie.addEventListener('click', closeCookieModal);
    cookieLoginModal.addEventListener('click', function(e) {
        if (e.target === cookieLoginModal) closeCookieModal();
    });
    
    // 验证并保存 Cookie
    btnSaveCookie.addEventListener('click', async function() {
        let cookieValue = cookieInput.value.trim();
        if (!cookieValue) {
            cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-500 bg-opacity-20 text-yellow-400 border border-yellow-500 border-opacity-30';
            cookieStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>请输入 MUSIC_U 值';
            cookieStatus.classList.remove('hidden');
            return;
        }
        
        // 自动添加 MUSIC_U= 前缀（如果用户粘贴了完整的也能处理）
        let cookie = cookieValue;
        if (!cookieValue.includes('MUSIC_U=')) {
            cookie = 'MUSIC_U=' + cookieValue;
        }
        
        btnSaveCookie.disabled = true;
        btnSaveCookie.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>验证中...';
        
        try {
            // 先验证 Cookie 是否有效
            const formData = new FormData();
            formData.append('cookie', cookie);
            
            const checkRes = await fetch('/api/ncm/check', {
                method: 'POST',
                body: formData
            });
            const checkData = await checkRes.json();
            
            if (checkData.logged_in) {
                // Cookie 有效，保存
                const saveRes = await fetch('/api/ncm/cookie/save', {
                    method: 'POST',
                    body: formData
                });
                const saveData = await saveRes.json();
                
                if (saveData.status === 'ok') {
                    cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-green-500 bg-opacity-20 text-green-400 border border-green-500 border-opacity-30';
                    cookieStatus.innerHTML = '<i class="fas fa-check-circle mr-2"></i>登录成功！欢迎，' + checkData.nickname;
                    cookieStatus.classList.remove('hidden');
                    
                    // 2秒后关闭弹窗并刷新
                    setTimeout(() => {
                        closeCookieModal();
                        loadConfig();
                    }, 2000);
                } else {
                    throw new Error(saveData.message || '保存失败');
                }
            } else {
                cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
                cookieStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>' + (checkData.message || 'Cookie 无效或已过期');
                cookieStatus.classList.remove('hidden');
            }
        } catch (e) {
            console.error('验证 Cookie 失败:', e);
            cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
            cookieStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>验证失败: ' + e.message;
            cookieStatus.classList.remove('hidden');
        } finally {
            btnSaveCookie.disabled = false;
            btnSaveCookie.innerHTML = '<i class="fas fa-check mr-2"></i>验证并保存';
        }
    });

    loadConfig();
</script>
{% endblock %}
