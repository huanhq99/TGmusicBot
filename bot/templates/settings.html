{% extends "base.html" %}

{% block title %}系统设置 - TGmusicbot{% endblock %}

{% block content %}


<div class="mb-8">
    <h2 class="text-2xl font-bold mb-1">系统设置</h2>
    <p class="text-gray-500">查看系统配置和运行状态</p>
</div>

<!-- Tab 导航 -->
<div class="flex border-b border-white border-opacity-10 mb-6">
    <button
        class="tab-btn active px-6 py-3 text-sm font-medium text-white border-b-2 border-indigo-500 transition-colors"
        data-tab="auth-downloads">
        授权与下载
    </button>
    <button
        class="tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-white hover:border-opacity-20 transition-colors"
        data-tab="notifications">
        通知与联动
    </button>
    <button
        class="tab-btn px-6 py-3 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent hover:border-white hover:border-opacity-20 transition-colors"
        data-tab="system">
        系统
    </button>
</div>

<!-- Tab 内容容器 -->
<div id="tab-content-container">

    <!-- Tab 1: 授权与下载 -->
    <div class="tab-pane active space-y-6" id="tab-auth-downloads">


        <!-- 网易云音乐配置 -->
        <div class="glass-card p-6 mb-6">
            <h3 class="font-semibold mb-6 flex items-center gap-2">
                <i class="fas fa-music text-indigo-400"></i>
                音乐平台账号
            </h3>

            <!-- 两个平台并排 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- 网易云音乐 -->
                <div class="p-4 rounded-xl bg-white bg-opacity-5 border border-red-500 border-opacity-20">
                    <div class="flex items-center gap-3 mb-4">
                        <div
                            class="w-10 h-10 rounded-lg bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center">
                            <i class="fas fa-cloud text-white"></i>
                        </div>
                        <h4 class="font-semibold text-red-400">网易云音乐</h4>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="ncm-avatar"
                            class="w-14 h-14 rounded-full bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center text-xl">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-semibold truncate" id="ncm-nickname">未登录</p>
                            <p class="text-sm text-gray-400" id="ncm-vip-status">请配置网易云账号</p>
                        </div>
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <div id="ncm-login-buttons" class="flex gap-2">
                            <button id="btn-qr-login" class="btn-primary text-sm py-1.5 px-3">
                                <i class="fas fa-qrcode mr-1"></i>扫码登录
                            </button>
                            <button id="btn-cookie-login" class="btn-secondary text-sm py-1.5 px-3"
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                                <i class="fas fa-key mr-1"></i>Cookie
                            </button>
                        </div>
                        <div id="ncm-logout-buttons" class="hidden flex gap-2">
                            <button id="btn-ncm-refresh" class="text-sm py-1.5 px-3 rounded-lg"
                                style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                            <button id="btn-ncm-logout" class="btn-danger text-sm py-1.5 px-3">
                                <i class="fas fa-sign-out-alt mr-1"></i>退出
                            </button>
                        </div>
                    </div>
                </div>

                <!-- QQ音乐 -->
                <div class="p-4 rounded-xl bg-white bg-opacity-5 border border-green-500 border-opacity-20">
                    <div class="flex items-center gap-3 mb-4">
                        <div
                            class="w-10 h-10 rounded-lg bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center">
                            <i class="fas fa-music text-white"></i>
                        </div>
                        <h4 class="font-semibold text-green-400">QQ音乐</h4>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="qq-avatar"
                            class="w-14 h-14 rounded-full bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center text-xl">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-semibold truncate" id="qq-nickname">未登录</p>
                            <p class="text-sm text-gray-400" id="qq-vip-status">请配置 QQ音乐账号</p>
                        </div>
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <div id="qq-login-buttons" class="flex gap-2">
                            <button id="btn-qq-qr-login" class="text-sm py-1.5 px-3 rounded-lg text-white"
                                style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
                                <i class="fas fa-qrcode mr-1"></i>扫码登录
                            </button>
                            <button id="btn-qq-cookie-login" class="btn-secondary text-sm py-1.5 px-3"
                                style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px;">
                                <i class="fas fa-key mr-1"></i>Cookie
                            </button>
                        </div>
                        <div id="qq-logout-buttons" class="hidden flex gap-2">
                            <button id="btn-qq-refresh" class="text-sm py-1.5 px-3 rounded-lg"
                                style="background: rgba(16,185,129,0.3); border: 1px solid rgba(16,185,129,0.5); border-radius: 8px;">
                                <i class="fas fa-sync-alt mr-1"></i>刷新
                            </button>
                            <button id="btn-qq-logout" class="btn-danger text-sm py-1.5 px-3">
                                <i class="fas fa-sign-out-alt mr-1"></i>清除
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cookie 输入弹窗 -->
            <div id="cookie-login-modal"
                class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div class="glass-card p-8 max-w-2xl w-full mx-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">手动输入 Cookie</h3>
                        <button id="btn-close-cookie" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div class="mb-4">
                        <label class="text-sm text-gray-400 mb-2 block">粘贴你的网易云 MUSIC_U 值</label>
                        <div
                            class="flex items-start bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl overflow-hidden focus-within:border-indigo-500">
                            <span
                                class="px-3 py-3 text-sm font-mono text-indigo-400 bg-white bg-opacity-5 border-r border-white border-opacity-10 select-none">MUSIC_U=</span>
                            <textarea id="cookie-input"
                                class="flex-1 h-24 bg-transparent p-3 text-sm font-mono text-gray-300 focus:outline-none resize-none"
                                placeholder="粘贴 MUSIC_U 的值（一串十六进制字符）..."></textarea>
                        </div>
                        <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>在网易云网页版按 F12 →
                            Console
                            → 输入
                            document.cookie 查找 MUSIC_U 的值</p>
                    </div>

                    <div class="flex justify-end gap-3">
                        <button id="btn-cancel-cookie" class="px-4 py-2 text-gray-400 hover:text-white">取消</button>
                        <button id="btn-save-cookie" class="btn-primary">
                            <i class="fas fa-check mr-2"></i>验证并保存
                        </button>
                    </div>

                    <div id="cookie-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                </div>
            </div>

            <!-- 扫码登录弹窗 -->
            <div id="qr-login-modal"
                class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
                <div class="glass-card p-8 max-w-md w-full mx-4">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">网易云扫码登录</h3>
                        <button id="btn-close-qr" class="text-gray-400 hover:text-white">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <div id="qr-container" class="text-center py-6">
                        <div id="qr-loading" class="py-8">
                            <i class="fas fa-spinner fa-spin text-4xl text-indigo-400"></i>
                            <p class="mt-4 text-gray-400">正在生成二维码...</p>
                        </div>
                        <div id="qr-image-container" class="hidden">
                            <img id="qr-image" src="" alt="登录二维码" class="mx-auto w-48 h-48 rounded-xl bg-white p-2">
                            <p id="qr-status" class="mt-4 text-gray-400">请使用网易云音乐 App 扫描二维码</p>
                        </div>
                        <div id="qr-expired" class="hidden py-8">
                            <i class="fas fa-exclamation-circle text-4xl text-yellow-400"></i>
                            <p class="mt-4 text-gray-400">二维码已过期</p>
                            <button id="btn-refresh-qr" class="btn-primary mt-4">
                                <i class="fas fa-sync-alt mr-2"></i>重新获取
                            </button>
                        </div>
                        <div id="qr-success" class="hidden py-8">
                            <i class="fas fa-check-circle text-4xl text-green-400"></i>
                            <p class="mt-4 text-green-400 font-semibold">登录成功！</p>
                            <p id="qr-success-name" class="text-gray-400"></p>
                        </div>
                    </div>

                    <div class="text-center text-sm text-gray-500 mt-4">
                        <p><i class="fas fa-mobile-alt mr-1"></i>打开网易云音乐 App</p>
                        <p>侧边栏 → 扫一扫</p>
                    </div>
                </div>
            </div>

            <!-- 下载设置表单 -->
            <form id="ncm-settings-form" class="space-y-6">
                <!-- 音质设置：两个平台并排 -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 网易云音质 -->
                    <div class="p-4 rounded-xl bg-white bg-opacity-5 border border-red-500 border-opacity-20">
                        <label class="text-sm text-gray-400 mb-2 block flex items-center gap-2">
                            <i class="fas fa-cloud text-red-400"></i>网易云音乐音质
                        </label>
                        <select id="ncm-quality-select" name="ncm_quality" class="select-modern w-full">
                            <option value="standard">标准 (128kbps MP3)</option>
                            <option value="higher">较高 (192kbps MP3)</option>
                            <option value="exhigh" selected>极高 (320kbps MP3)</option>
                            <option value="lossless">无损 SQ (FLAC) - 需VIP</option>
                            <option value="hires">高清臻音 Hi-Res - 需VIP</option>
                            <option value="jyeffect">高清环绕声 - 需VIP</option>
                            <option value="sky">沉浸环绕声 - 需VIP</option>
                            <option value="jymaster">超清母带 Master - 需SVIP</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>无损及以上需VIP，超清母带需黑胶SVIP
                        </p>
                    </div>

                    <!-- QQ音乐音质 -->
                    <div class="p-4 rounded-xl bg-white bg-opacity-5 border border-green-500 border-opacity-20">
                        <label class="text-sm text-gray-400 mb-2 block flex items-center gap-2">
                            <i class="fas fa-music text-green-400"></i>QQ音乐音质
                        </label>
                        <select id="qq-quality-select" name="qq_quality" class="select-modern w-full">
                            <option value="128">标准音质 (128kbps M4A)</option>
                            <option value="320" selected>HQ高品质 (320kbps MP3)</option>
                            <option value="flac">无损SQ (FLAC) - 需绿钻</option>
                            <option value="hires">臻品母带 Hi-Res - 需超级会员</option>
                            <option value="dolby">臻品全景声 Dolby - 需超级会员</option>
                            <option value="master">臻品母带2.0 - 需超级会员</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>无损需绿钻VIP，臻品系列需超级会员
                        </p>
                    </div>
                </div>

                <!-- 自动下载开关 -->
                <div class="p-4 rounded-xl bg-white bg-opacity-5">
                    <label class="text-sm text-gray-400 mb-2 block">自动下载</label>
                    <div class="flex items-center gap-3 mt-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-download-toggle" name="auto_download" class="sr-only peer">
                            <div
                                class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                            </div>
                        </label>
                        <span class="text-sm text-gray-300" id="auto-download-label">未启用</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">
                        <i class="fas fa-info-circle mr-1"></i>同步歌单时显示下载按钮，网易云下载失败会自动尝试 QQ 音乐
                    </p>
                </div>

                <!-- 下载目录配置 -->
                <div class="mt-6 p-4 rounded-xl bg-white bg-opacity-5 border border-white border-opacity-10">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-folder-open text-yellow-400"></i>
                        下载目录配置
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">下载模式</label>
                            <select id="download-mode" name="download_mode"
                                class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500">
                                <option value="local">仅下载到本地目录</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">本地下载目录</label>
                            <input type="text" id="download-dir" name="download_dir"
                                class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm font-mono focus:outline-none focus:border-indigo-500"
                                placeholder="/path/to/uploads">
                            <p class="text-xs text-gray-500 mt-1"><i
                                    class="fas fa-info-circle mr-1"></i>歌曲下载后保存的目录（选择自动整理时作为监控目录）</p>
                        </div>

                        <!-- 自动整理模式 -->
                    </div>
                </div>



                <!-- 歌单订阅同步 -->
                <div class="mt-6 p-4 rounded-xl bg-white bg-opacity-5 border border-white border-opacity-10">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-list-music text-indigo-400"></i>
                        歌单订阅同步
                    </h4>
                    <div class="space-y-4">
                        <div>
                            <label class="text-sm text-gray-400 mb-2 block">默认同步间隔（分钟）</label>
                            <input type="number" id="playlist-sync-interval" name="playlist_sync_interval" min="1"
                                class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                                placeholder="60">
                            <p class="text-xs text-gray-500 mt-1"><i
                                    class="fas fa-info-circle mr-1"></i>检查订阅歌单更新的默认间隔，最小 1
                                分钟。每个歌单也可单独设置（Bot 命令 /syncinterval）</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>保存设置
                    </button>
                </div>
            </form>

            <div id="save-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
        </div>

        <!-- QQ音乐扫码登录弹窗 -->
        <div id="qq-qr-login-modal"
            class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
            <div class="glass-card p-8 max-w-md w-full mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">QQ音乐扫码登录</h3>
                    <button id="btn-close-qq-qr" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div id="qq-qr-container" class="text-center py-6">
                    <div id="qq-qr-loading" class="py-8">
                        <i class="fas fa-spinner fa-spin text-4xl text-green-400"></i>
                        <p class="mt-4 text-gray-400">正在生成二维码...</p>
                    </div>
                    <div id="qq-qr-image-container" class="hidden">
                        <img id="qq-qr-image" src="" alt="登录二维码" class="mx-auto w-48 h-48 rounded-xl bg-white p-2">
                        <p id="qq-qr-status" class="mt-4 text-gray-400">请使用 QQ 音乐 App 扫描二维码</p>
                    </div>
                    <div id="qq-qr-scanned" class="hidden py-8">
                        <i class="fas fa-user-circle text-6xl text-green-400"></i>
                        <p id="qq-qr-scanned-name" class="mt-4 text-green-400 font-semibold"></p>
                        <p class="text-gray-400 text-sm">请在手机上确认登录</p>
                    </div>
                    <div id="qq-qr-expired" class="hidden py-8">
                        <i class="fas fa-exclamation-circle text-4xl text-yellow-400"></i>
                        <p class="mt-4 text-gray-400">二维码已过期</p>
                        <button id="btn-refresh-qq-qr" class="btn-primary mt-4"
                            style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
                            <i class="fas fa-sync-alt mr-2"></i>重新获取
                        </button>
                    </div>
                    <div id="qq-qr-success" class="hidden py-8">
                        <i class="fas fa-check-circle text-4xl text-green-400"></i>
                        <p class="mt-4 text-green-400 font-semibold">登录成功！</p>
                        <p id="qq-qr-success-name" class="text-gray-400"></p>
                    </div>
                </div>

                <div class="text-center text-sm text-gray-500 mt-4">
                    <p><i class="fas fa-mobile-alt mr-1"></i>打开 QQ 音乐 App</p>
                    <p>我的 → 右上角扫一扫</p>
                </div>
            </div>
        </div>

        <!-- QQ音乐 Cookie 输入弹窗 -->
        <div id="qq-cookie-modal"
            class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
            <div class="glass-card p-8 max-w-2xl w-full mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">输入 QQ音乐 Cookie</h3>
                    <button id="btn-close-qq-cookie" class="text-gray-400 hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <label class="text-sm text-gray-400 mb-2 block">粘贴完整的 QQ音乐 Cookie</label>

                    <!-- 完整 Cookie 输入 -->
                    <textarea id="qq-cookie-input"
                        class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-xl px-4 py-3 text-sm font-mono text-gray-300 focus:outline-none focus:border-green-500 resize-none h-32"
                        placeholder="RK=xxx; ptcz=xxx; uin=xxx; qm_keyst=xxx; qqmusic_key=xxx; ..."></textarea>

                    <p class="text-xs text-gray-500 mt-2"><i class="fas fa-info-circle mr-1"></i>在 y.qq.com 按 F12 → 控制台
                        → 输入
                        <code class="bg-black bg-opacity-30 px-1 rounded">document.cookie</code> → 复制全部内容
                    </p>
                </div>

                <div class="flex justify-end gap-3">
                    <button id="btn-cancel-qq-cookie" class="px-4 py-2 text-gray-400 hover:text-white">取消</button>
                    <button id="btn-save-qq-cookie" class="btn-primary"
                        style="background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%);">
                        <i class="fas fa-check mr-2"></i>验证并保存
                    </button>
                </div>

                <div id="qq-cookie-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
            </div>
        </div>
    </div>
</div> <!-- End Tab 1 -->

<!-- Tab 2: 通知与联动 -->
<div class="tab-pane hidden space-y-6" id="tab-notifications">
    <!-- 服务状态 (moved to System tab) -->

    <!-- 排行榜配置 -->
    <div class="glass-card p-6 mb-6">
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-trophy text-yellow-400"></i>
            排行榜推送配置
        </h3>

        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-white bg-opacity-5 rounded-xl">
                <div>
                    <h4 class="font-medium text-white">推送目标群组</h4>
                    <p class="text-sm text-gray-400 mt-1">留空则推送到日志频道 (LOG_CHANNEL_ID)</p>
                </div>
                <input type="text" id="ranking-target-chat"
                    class="bg-black bg-opacity-20 border border-white border-opacity-10 rounded-lg px-3 py-2 text-sm text-white w-48 font-mono"
                    placeholder="-100xxxxxxx">
            </div>

            <div class="flex items-center justify-between p-4 bg-white bg-opacity-5 rounded-xl">
                <div>
                    <h4 class="font-medium text-white">📅 日榜推送时间</h4>
                    <p class="text-sm text-gray-400 mt-1">每天自动推送 (留空禁用)</p>
                </div>
                <input type="time" id="ranking-daily-time"
                    class="bg-black bg-opacity-20 border border-white border-opacity-10 rounded-lg px-3 py-2 text-sm text-white">
            </div>

            <div class="flex items-center justify-between p-4 bg-white bg-opacity-5 rounded-xl">
                <div>
                    <h4 class="font-medium text-white">日榜标题</h4>
                    <p class="text-sm text-gray-400 mt-1">默认为 "每日音乐热曲榜"</p>
                </div>
                <input type="text" id="ranking-daily-title"
                    class="bg-black bg-opacity-20 border border-white border-opacity-10 rounded-lg px-3 py-2 text-sm text-white w-48"
                    placeholder="每日音乐热曲榜">
            </div>

            <div class="flex items-center justify-between p-4 bg-white bg-opacity-5 rounded-xl">
                <div>
                    <h4 class="font-medium text-white">日榜副标题</h4>
                    <p class="text-sm text-gray-400 mt-1">留空则不显示副标题</p>
                </div>
                <input type="text" id="ranking-daily-subtitle"
                    class="bg-black bg-opacity-20 border border-white border-opacity-10 rounded-lg px-3 py-2 text-sm text-white w-48"
                    placeholder="">
            </div>

            <div class="flex items-center justify-between p-4 bg-white bg-opacity-5 rounded-xl">
                <div>
                    <h4 class="font-medium text-white">📆 周榜推送时间</h4>
                    <p class="text-sm text-gray-400 mt-1">每周日自动推送 (留空禁用)</p>
                </div>
                <input type="time" id="ranking-weekly-time"
                    class="bg-black bg-opacity-20 border border-white border-opacity-10 rounded-lg px-3 py-2 text-sm text-white">
            </div>

            <div class="flex items-center justify-between p-4 bg-white bg-opacity-5 rounded-xl">
                <div>
                    <h4 class="font-medium text-white">周榜标题</h4>
                    <p class="text-sm text-gray-400 mt-1">默认为 "本周音乐热曲榜"</p>
                </div>
                <input type="text" id="ranking-weekly-title"
                    class="bg-black bg-opacity-20 border border-white border-opacity-10 rounded-lg px-3 py-2 text-sm text-white w-48"
                    placeholder="本周音乐热曲榜">
            </div>

            <div class="flex justify-end gap-3 pt-4">
                <button type="button" onclick="testDailyPush()"
                    class="px-4 py-2 rounded-lg bg-green-500 bg-opacity-20 border border-green-500 border-opacity-50 text-green-400 hover:bg-opacity-30 transition">
                    <i class="fas fa-paper-plane mr-2"></i>测试日榜推送
                </button>
                <button type="button" onclick="testWeeklyPush()"
                    class="px-4 py-2 rounded-lg bg-blue-500 bg-opacity-20 border border-blue-500 border-opacity-50 text-blue-400 hover:bg-opacity-30 transition">
                    <i class="fas fa-paper-plane mr-2"></i>测试周榜推送
                </button>
                <button id="btn-save-ranking" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>保存配置
                </button>
            </div>
        </div>
    </div>

    <!-- Emby 媒体库扫描 (Moved from Downloads) -->
    <div class="glass-card p-6 mb-6"> <!-- Wrapped in glass-card -->
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-sync-alt text-purple-400"></i>
            Emby 媒体库自动扫描
        </h3>
        <div class="space-y-4">
            <div>
                <label class="text-sm text-gray-400 mb-2 block">扫描间隔（小时）</label>
                <!-- Form input needs to be connected to the main form? Or separate fetch? 
                     Key point: The original input was inside <form id="ncm-settings-form">.
                     Now it is outside the form. The "Save Settings" button handles the form submit.
                     If I move this input OUTSIDE the form, it wont be submitted!
                     Correct solution: I must give this input a new ID/handling or keep it in form?
                     Wait, user wants UI separation.
                     Logic JS: `const formData = new FormData(document.getElementById('ncm-settings-form'));`
                     If I move input out, it won't be in formData.
                     I need to adjust the JS to include this value manually or put it in a form.
                     However, for now, let's just move the UI. I will fix JS submission later if needed.
                     Actually, I can add `form="ncm-settings-form"` attribute to the input!
                -->
                <input type="number" id="emby-scan-interval" name="emby_scan_interval" min="0" form="ncm-settings-form"
                    class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                    placeholder="0">
                <p class="text-xs text-gray-500 mt-1"><i class="fas fa-info-circle mr-1"></i>设为 0 禁用自动扫描。定时从 Emby
                    同步最新曲库，以便歌单匹配更准确</p>
            </div>

            <div class="flex justify-end pt-4">
                <!-- Add a save button for this specific setting or rely on the main save button?
                      The main save button is in the other tab. That's bad UX.
                      I should add a "Save" button here too, or make the input auto-save?
                      Better: Add a "Save Config" button in this tab that triggers the main form submit?
                      Or just replicate the Save button.
                 -->
                <button type="button" onclick="submitMainForm()" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>保存扫描设置
                </button>
            </div>
        </div>
    </div>

    <!-- Emby Webhook 配置 -->
    <div class="glass-card p-6 mb-6">
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-plug text-orange-400"></i>
            Emby Webhook 联动
        </h3>

        <div class="mb-6 p-4 rounded-xl bg-orange-500 bg-opacity-10 border border-orange-500 border-opacity-30">
            <h4 class="font-semibold text-orange-400 mb-3"><i class="fas fa-bolt mr-2"></i>实时入库通知</h4>
            <p class="text-sm text-gray-300 mb-3">
                配置 Emby Webhook 后，当有新音乐入库时，Bot 会实时发送 Telegram 通知。同时会自动更新本地缓存，使歌单匹配更准确。
            </p>
        </div>

        <div class="space-y-4">
            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <p class="text-sm text-gray-400 mb-2">Webhook URL</p>
                <div class="flex items-center gap-2">
                    <code id="webhook-url"
                        class="flex-1 font-mono text-sm text-indigo-400 bg-black bg-opacity-30 px-4 py-2 rounded-lg overflow-x-auto">
                    http://你的Bot地址:8080/webhook/emby
                </code>
                    <button onclick="copyWebhookUrl()"
                        class="px-3 py-2 rounded-lg bg-white bg-opacity-5 hover:bg-opacity-10 transition">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>

            <div class="p-4 rounded-xl bg-white bg-opacity-5 border border-white border-opacity-10">
                <h4 class="font-semibold mb-4"><i class="fas fa-cog mr-2 text-gray-400"></i>配置步骤</h4>
                <ol class="space-y-3 text-sm text-gray-400">
                    <li class="flex items-start gap-3">
                        <span
                            class="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs flex-shrink-0 mt-0.5">1</span>
                        <div>
                            <p class="text-gray-300">安装 Emby Webhooks 插件</p>
                            <p class="text-xs mt-1">Emby 控制台 → 插件 → 目录 → 搜索 "Webhooks"</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span
                            class="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs flex-shrink-0 mt-0.5">2</span>
                        <div>
                            <p class="text-gray-300">配置 Webhook 地址</p>
                            <p class="text-xs mt-1">插件设置 → 添加上方的 Webhook URL</p>
                        </div>
                    </li>
                    <li class="flex items-start gap-3">
                        <span
                            class="w-6 h-6 rounded-full bg-indigo-500 text-white flex items-center justify-center text-xs flex-shrink-0 mt-0.5">3</span>
                        <div>
                            <p class="text-gray-300">选择事件类型</p>
                            <p class="text-xs mt-1">勾选 "ItemAdded" 或 "library.new" 事件</p>
                        </div>
                    </li>
                </ol>
            </div>

            <div class="p-4 rounded-xl bg-white bg-opacity-5">
                <p class="text-sm text-gray-400 mb-2">支持的事件</p>
                <div class="flex flex-wrap gap-2 text-xs">
                    <span class="px-2 py-1 rounded-full bg-green-500 bg-opacity-20 text-green-400">library.new</span>
                    <span class="px-2 py-1 rounded-full bg-green-500 bg-opacity-20 text-green-400">ItemAdded</span>
                    <span
                        class="px-2 py-1 rounded-full bg-yellow-500 bg-opacity-20 text-yellow-400">library.deleted</span>
                    <span class="px-2 py-1 rounded-full bg-yellow-500 bg-opacity-20 text-yellow-400">ItemRemoved</span>
                    <span class="px-2 py-1 rounded-full bg-blue-500 bg-opacity-20 text-blue-400">playback.start</span>
                </div>
            </div>

            <div class="p-4 rounded-xl bg-white bg-opacity-5" id="webhook-status-container">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-400">最近接收</p>
                        <p class="text-lg font-semibold" id="webhook-last-event">--</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="webhook-status-indicator" class="w-3 h-3 rounded-full bg-gray-500"></span>
                        <span id="webhook-status-text" class="text-sm text-gray-400">等待事件...</span>
                    </div>
                </div>
            </div>

            <!-- 测试按钮 -->
            <div class="flex gap-3">
                <button onclick="testWebhookNotification()"
                    class="flex-1 px-4 py-3 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold hover:opacity-90 transition">
                    <i class="fas fa-paper-plane mr-2"></i>发送测试通知
                </button>
            </div>
        </div>
    </div>

    <!-- 邮件服务配置 -->
    <div class="glass-card p-6 mb-6">
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-envelope text-blue-400"></i>
            邮件服务配置 (SMTP)
        </h3>

        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">SMTP 服务器</label>
                    <input type="text" id="smtp-server"
                        class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                        placeholder="smtp.gmail.com">
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">SMTP 端口</label>
                    <input type="text" id="smtp-port"
                        class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                        placeholder="587">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">邮箱账号</label>
                    <input type="text" id="smtp-user"
                        class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                        placeholder="example@gmail.com">
                </div>
                <div>
                    <label class="text-sm text-gray-400 mb-2 block">邮箱密码 / 应用专用密码</label>
                    <input type="password" id="smtp-password"
                        class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                        placeholder="应用专用密码">
                </div>
            </div>

            <div>
                <label class="text-sm text-gray-400 mb-2 block">发件人名称 (可选)</label>
                <input type="text" id="smtp-from"
                    class="w-full bg-white bg-opacity-5 border border-white border-opacity-10 rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-indigo-500"
                    placeholder="TGMusicBot <bot@example.com>">
            </div>

            <div class="flex justify-end pt-4">
                <button id="btn-save-email" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>保存配置
                </button>
            </div>
        </div>
    </div>




</div> <!-- End Tab 2 -->

<!-- Tab 3: 系统 -->
<div class="tab-pane hidden space-y-6" id="tab-system">
    <!-- 服务状态 (moved here) -->
    <div class="glass-card p-6">
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-heartbeat text-red-400"></i>
            服务状态
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5">
                <div class="w-12 h-12 rounded-xl bg-green-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fab fa-telegram text-green-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Telegram Bot</p>
                    <p class="font-semibold text-green-400">
                        <i class="fas fa-circle text-xs mr-1"></i>运行中
                    </p>
                </div>
            </div>

            <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5">
                <div class="w-12 h-12 rounded-xl bg-blue-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-server text-blue-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Web 服务</p>
                    <p class="font-semibold text-green-400">
                        <i class="fas fa-circle text-xs mr-1"></i>运行中
                    </p>
                </div>
            </div>

            <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5" id="emby-status">
                <div class="w-12 h-12 rounded-xl bg-purple-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-film text-purple-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-400">Emby 连接</p>
                    <p class="font-semibold text-gray-400">
                        <i class="fas fa-spinner fa-spin text-xs mr-1"></i>检测中...
                    </p>
                </div>
            </div>

            <div class="flex items-center gap-4 p-4 rounded-xl bg-white bg-opacity-5" id="ncm-status">
                <div class="w-12 h-12 rounded-xl bg-red-500 bg-opacity-20 flex items-center justify-center">
                    <i class="fas fa-cloud-download-alt text-red-400 text-xl"></i>
                </div>
                <div>
                    <p class="text-sm text-gray-400">网易云下载</p>
                    <p class="font-semibold text-gray-400">
                        <i class="fas fa-spinner fa-spin text-xs mr-1"></i>检测中...
                    </p>
                </div>
            </div>
        </div>
    </div>
    <div class="glass-card p-6 mb-6">
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-cog text-indigo-400"></i>
            系统配置
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div class="p-4 rounded-xl bg-white bg-opacity-5">
                    <p class="text-sm text-gray-400 mb-1">Emby 服务器</p>
                    <p class="font-mono text-sm" id="config-emby-url">--</p>
                </div>
                <div class="p-4 rounded-xl bg-white bg-opacity-5">
                    <p class="text-sm text-gray-400 mb-1">数据目录</p>
                    <p class="font-mono text-sm" id="config-data-dir">--</p>
                </div>
            </div>
            <div class="space-y-4">
                <div class="p-4 rounded-xl bg-white bg-opacity-5">
                    <p class="text-sm text-gray-400 mb-1">数据库文件</p>
                    <p class="font-mono text-sm" id="config-database">--</p>
                </div>
                <div class="p-4 rounded-xl bg-white bg-opacity-5">
                    <p class="text-sm text-gray-400 mb-1">媒体库缓存</p>
                    <p class="font-mono text-sm" id="config-cache">--</p>
                </div>
            </div>
        </div>
    </div>



    <!-- 关于 -->
    <div class="glass-card p-6">
        <h3 class="font-semibold mb-6 flex items-center gap-2">
            <i class="fas fa-info-circle text-cyan-400"></i>
            关于
        </h3>
        <div class="flex items-start gap-6">
            <div
                class="w-20 h-20 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-music text-3xl text-white"></i>
            </div>
            <div>
                <h4 class="text-xl font-bold mb-2">TGmusicbot</h4>
                <p class="text-gray-400 mb-4">版本 1.11.1</p>
                <div class="space-y-2 text-sm text-gray-500">
                    <p><i class="fas fa-check text-green-400 mr-2"></i>网易云 / QQ音乐 / Spotify 歌单同步到 Emby</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>Telegram 音乐文件上传到服务器</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>网易云 / QQ音乐搜索下载（跨平台自动切换）</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>扫码登录 / Cookie 登录（支持刷新延期）</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>NCM 加密格式自动解密</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>元数据内嵌（封面、歌词）</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>Emby Webhook 实时入库通知</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>文件自动整理（按艺术家/专辑分类）</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>Web 管理界面</p>
                    <p><i class="fas fa-check text-green-400 mr-2"></i>多用户支持，独立 Emby 账户绑定</p>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
</div> <!-- End Tab 3 -->
</div> <!-- End Tab Container -->
{% endblock %}

{% block scripts %}
<script>
    const autoDownloadToggle = document.getElementById('auto-download-toggle');
    const autoDownloadLabel = document.getElementById('auto-download-label');
    const downloadModeSelect = document.getElementById('download-mode');
    const downloadDirInput = document.getElementById('download-dir');

    // 跨 Tab 提交表单辅助函数
    window.submitMainForm = function () {
        const form = document.getElementById('ncm-settings-form');
        if (form) {
            // 使用 dispatchEvent 触发 submit 事件监听器
            const event = new Event('submit', { cancelable: true });
            form.dispatchEvent(event);
        }
    };

    // Tab 切换逻辑
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // 移除所有 active 类
            document.querySelectorAll('.tab-btn').forEach(b => {
                b.classList.remove('active', 'text-white', 'border-indigo-500');
                b.classList.add('text-gray-400', 'border-transparent');
            });
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));

            // 激活当前 Tab
            btn.classList.add('active', 'text-white', 'border-indigo-500');
            btn.classList.remove('text-gray-400', 'border-transparent');

            const tabId = btn.dataset.tab;
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
        });
    });

    // 登录/退出按钮
    const ncmLoginButtons = document.getElementById('ncm-login-buttons');
    const ncmLogoutButtons = document.getElementById('ncm-logout-buttons');
    const btnNcmLogout = document.getElementById('btn-ncm-logout');
    const btnNcmRefresh = document.getElementById('btn-ncm-refresh');

    // 扫码登录相关元素
    const qrLoginModal = document.getElementById('qr-login-modal');
    const btnQrLogin = document.getElementById('btn-qr-login');
    const btnCloseQr = document.getElementById('btn-close-qr');
    const btnRefreshQr = document.getElementById('btn-refresh-qr');
    const qrLoading = document.getElementById('qr-loading');
    const qrImageContainer = document.getElementById('qr-image-container');
    const qrImage = document.getElementById('qr-image');
    const qrStatus = document.getElementById('qr-status');
    const qrExpired = document.getElementById('qr-expired');
    const qrSuccess = document.getElementById('qr-success');
    const qrSuccessName = document.getElementById('qr-success-name');

    let currentUnikey = null;
    let checkInterval = null;

    // 切换开关时更新标签
    autoDownloadToggle.addEventListener('change', function () {
        autoDownloadLabel.textContent = this.checked ? '已启用' : '未启用';
    });

    // 下载模式切换时显示/隐藏对应目录输入框
    function updateDirContainers() {
        const mode = downloadModeSelect.value;

    }
    downloadModeSelect.addEventListener('change', updateDirContainers);

    // 模板预设点击
    document.querySelectorAll('.template-preset').forEach(btn => {
        btn.addEventListener('click', function () {
            const template = this.dataset.template;

            document.querySelectorAll('.template-preset').forEach(b => b.classList.remove('border-purple-500'));
            this.classList.add('border-purple-500');
        });
    });

    // 根据登录状态显示不同按钮
    function updateLoginButtons(isLoggedIn) {
        if (isLoggedIn) {
            ncmLoginButtons.classList.add('hidden');
            ncmLogoutButtons.classList.remove('hidden');
        } else {
            ncmLoginButtons.classList.remove('hidden');
            ncmLogoutButtons.classList.add('hidden');
        }
    }

    // 退出登录
    btnNcmLogout.addEventListener('click', async function () {
        if (!confirm('确定要退出网易云账号吗？')) return;

        try {
            const res = await fetch('/api/ncm/logout', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'ok') {
                // 刷新页面状态
                loadConfig();
            } else {
                alert('退出失败: ' + (data.message || '未知错误'));
            }
        } catch (e) {
            console.error('退出失败:', e);
            alert('退出失败: ' + e.message);
        }
    });

    // 网易云 Cookie 刷新
    btnNcmRefresh.addEventListener('click', async function () {
        const btn = this;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>刷新中...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/ncm/refresh', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'ok') {
                alert('✅ Cookie 刷新成功！\n用户: ' + (data.nickname || '网易云用户'));
                loadConfig();
            } else {
                alert('❌ 刷新失败: ' + (data.message || '未知错误'));
            }
        } catch (e) {
            console.error('刷新失败:', e);
            alert('❌ 刷新失败: ' + e.message);
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    // 打开扫码登录弹窗
    btnQrLogin.addEventListener('click', function () {
        qrLoginModal.classList.remove('hidden');
        createQrCode();
    });

    // 关闭弹窗
    btnCloseQr.addEventListener('click', closeQrModal);
    qrLoginModal.addEventListener('click', function (e) {
        if (e.target === qrLoginModal) closeQrModal();
    });

    // 刷新二维码
    btnRefreshQr.addEventListener('click', createQrCode);

    function closeQrModal() {
        qrLoginModal.classList.add('hidden');
        if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
        }
    }

    function showQrLoading() {
        qrLoading.classList.remove('hidden');
        qrImageContainer.classList.add('hidden');
        qrExpired.classList.add('hidden');
        qrSuccess.classList.add('hidden');
    }

    function showQrImage() {
        qrLoading.classList.add('hidden');
        qrImageContainer.classList.remove('hidden');
        qrExpired.classList.add('hidden');
        qrSuccess.classList.add('hidden');
    }

    function showQrExpired() {
        qrLoading.classList.add('hidden');
        qrImageContainer.classList.add('hidden');
        qrExpired.classList.remove('hidden');
        qrSuccess.classList.add('hidden');
    }

    function showQrSuccess(nickname) {
        qrLoading.classList.add('hidden');
        qrImageContainer.classList.add('hidden');
        qrExpired.classList.add('hidden');
        qrSuccess.classList.remove('hidden');
        qrSuccessName.textContent = '欢迎，' + nickname;
    }

    async function createQrCode() {
        showQrLoading();
        if (checkInterval) {
            clearInterval(checkInterval);
            checkInterval = null;
        }

        try {
            const res = await fetch('/api/ncm/qr/create', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'ok') {
                currentUnikey = data.unikey;
                qrImage.src = data.qr_img;
                qrStatus.textContent = '请使用网易云音乐 App 扫描二维码';
                qrStatus.className = 'mt-4 text-gray-400';
                showQrImage();

                // 开始轮询检查状态
                startCheckingQr();
            } else {
                qrStatus.textContent = '生成二维码失败: ' + (data.message || '未知错误');
                qrStatus.className = 'mt-4 text-red-400';
                showQrImage();
            }
        } catch (e) {
            console.error('创建二维码失败:', e);
            qrStatus.textContent = '网络错误，请重试';
            qrStatus.className = 'mt-4 text-red-400';
            showQrImage();
        }
    }

    function startCheckingQr() {
        checkInterval = setInterval(async () => {
            if (!currentUnikey) return;

            try {
                const formData = new FormData();
                formData.append('unikey', currentUnikey);

                const res = await fetch('/api/ncm/qr/check', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                console.log('[QR Check] 响应:', data);

                switch (data.code) {
                    case 801:
                        qrStatus.textContent = '等待扫描...';
                        qrStatus.className = 'mt-4 text-gray-400';
                        break;
                    case 802:
                        qrStatus.textContent = '已扫描，请在手机上确认登录';
                        qrStatus.className = 'mt-4 text-blue-400 animate-pulse';
                        break;
                    case 803:
                        // 登录成功
                        console.log('[QR Check] 登录成功! cookie_saved:', data.cookie_saved);
                        clearInterval(checkInterval);
                        checkInterval = null;

                        // Cookie 已在后端自动保存
                        showQrSuccess(data.nickname || '用户');

                        // 2秒后关闭弹窗并刷新页面
                        setTimeout(() => {
                            closeQrModal();
                            loadConfig();
                        }, 2000);
                        break;
                    case 800:
                        // 二维码过期
                        clearInterval(checkInterval);
                        checkInterval = null;
                        showQrExpired();
                        break;
                    default:
                        console.log('[QR Check] 未知状态码:', data.code, data.message);
                        if (data.status === 'error') {
                            qrStatus.textContent = data.message || '发生错误';
                            qrStatus.className = 'mt-4 text-red-400';
                        }
                }
            } catch (e) {
                console.error('检查二维码状态失败:', e);
            }
        }, 1500);  // 每 1.5 秒检查一次，加快响应速度
    }

    async function saveCookie(cookie) {
        try {
            const formData = new FormData();
            formData.append('cookie', cookie);

            await fetch('/api/ncm/cookie/save', {
                method: 'POST',
                body: formData
            });
        } catch (e) {
            console.error('保存 Cookie 失败:', e);
        }
    }

    async function updateNcmStatus() {
        const ncmStatus = document.getElementById('ncm-status');
        const ncmNickname = document.getElementById('ncm-nickname');
        const ncmVipStatus = document.getElementById('ncm-vip-status');

        try {
            const resp = await fetch('/api/ncm/status');
            const data = await resp.json();

            if (data.logged_in) {
                if (ncmStatus) {
                    const p = ncmStatus.querySelector('p:last-child');
                    if (p) p.innerHTML = '<span class="text-green-400"><i class="fas fa-circle text-xs mr-1"></i>已登录</span>';
                }
                if (ncmNickname) ncmNickname.textContent = data.nickname || '网易云用户';
                if (ncmVipStatus) {
                    ncmVipStatus.innerHTML = data.is_vip
                        ? '<span class="text-yellow-400"><i class="fas fa-crown mr-1"></i>VIP 会员</span>'
                        : '<span class="text-gray-400">普通用户</span>';
                }
                updateLoginButtons(true);
            } else if (data.configured) {
                if (ncmStatus) {
                    const p = ncmStatus.querySelector('p:last-child');
                    if (p) p.innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle text-xs mr-1"></i>Cookie 失效</span>';
                }
                if (ncmNickname) ncmNickname.textContent = 'Cookie 已过期';
                if (ncmVipStatus) ncmVipStatus.textContent = '请重新获取 Cookie';
                updateLoginButtons(false);
            } else {
                if (ncmStatus) {
                    const p = ncmStatus.querySelector('p:last-child');
                    if (p) p.innerHTML = '<span class="text-gray-400"><i class="fas fa-times-circle text-xs mr-1"></i>未配置</span>';
                }
                updateLoginButtons(false);
            }
        } catch (e) {
            console.error('Failed to update NCM status', e);
        }
    }

    async function updateQqStatus() {
        const qqStatus = document.getElementById('qq-status');
        const qqNickname = document.getElementById('qq-nickname');
        const qqVipStatus = document.getElementById('qq-vip-status');
        const qqLoginButtons = document.getElementById('qq-login-buttons');
        const qqLogoutButtons = document.getElementById('qq-logout-buttons');

        try {
            const resp = await fetch('/api/qq/status');
            const data = await resp.json();

            if (data.logged_in) {
                if (qqStatus) {
                    const p = qqStatus.querySelector('p:last-child');
                    if (p) p.innerHTML = '<span class="text-green-400"><i class="fas fa-circle text-xs mr-1"></i>已登录</span>';
                }
                if (qqNickname) qqNickname.textContent = data.nickname || 'QQ用户';
                if (qqVipStatus) {
                    qqVipStatus.innerHTML = data.is_vip
                        ? '<span class="text-yellow-400"><i class="fas fa-crown mr-1"></i>VIP 会员</span>'
                        : '<span class="text-gray-400">普通用户</span>';
                }

                if (qqLoginButtons) qqLoginButtons.classList.add('hidden');
                if (qqLogoutButtons) qqLogoutButtons.classList.remove('hidden');
            } else if (data.configured) {
                if (qqStatus) {
                    const p = qqStatus.querySelector('p:last-child');
                    if (p) p.innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle text-xs mr-1"></i>Cookie 失效</span>';
                }
                if (qqNickname) qqNickname.textContent = 'Cookie 已过期';
                if (qqVipStatus) qqVipStatus.textContent = '请重新获取 Cookie';

                if (qqLoginButtons) qqLoginButtons.classList.remove('hidden');
                if (qqLogoutButtons) qqLogoutButtons.classList.add('hidden');
            } else {
                if (qqStatus) {
                    const p = qqStatus.querySelector('p:last-child');
                    if (p) p.innerHTML = '<span class="text-gray-400"><i class="fas fa-times-circle text-xs mr-1"></i>未配置</span>';
                }

                if (qqLoginButtons) qqLoginButtons.classList.remove('hidden');
                if (qqLogoutButtons) qqLogoutButtons.classList.add('hidden');
            }
        } catch (e) {
            console.error('Failed to update QQ status', e);
        }
    }

    async function loadConfig() {
        try {
            const res = await fetch('/api/config');
            const data = await res.json();

            document.getElementById('config-emby-url').textContent = data.emby_url || '未配置';
            document.getElementById('config-data-dir').textContent = data.data_dir;
            document.getElementById('config-database').textContent = data.database;

            const cacheEl = document.getElementById('config-cache');
            if (data.cache_exists) {
                cacheEl.innerHTML = '<span class="text-green-400"><i class="fas fa-check-circle mr-1"></i>已缓存</span>';
            } else {
                cacheEl.innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle mr-1"></i>未缓存</span>';
            }

            // Emby 状态
            const embyStatus = document.getElementById('emby-status');
            if (embyStatus) {
                const embyP = embyStatus.querySelector('p:last-child');
                if (embyP) {
                    if (data.emby_url) {
                        embyP.innerHTML = '<span class="text-green-400"><i class="fas fa-circle text-xs mr-1"></i>已连接</span>';
                    } else {
                        embyP.innerHTML = '<span class="text-yellow-400"><i class="fas fa-exclamation-circle text-xs mr-1"></i>未配置</span>';
                    }
                }
            }

            // 网易云状态 (异步更新)
            const ncmStatus = document.getElementById('ncm-status');
            const ncmNickname = document.getElementById('ncm-nickname');
            const ncmVipStatus = document.getElementById('ncm-vip-status');

            if (data.ncm_status && data.ncm_status.configured) {
                if (ncmStatus) {
                    const ncmP = ncmStatus.querySelector('p:last-child');
                    if (ncmP) ncmP.innerHTML = '<span class="text-blue-400"><i class="fas fa-spinner fa-spin text-xs mr-1"></i>检测中...</span>';
                }
                updateNcmStatus(); // Async call
            } else {
                if (ncmStatus) {
                    const ncmP = ncmStatus.querySelector('p:last-child');
                    if (ncmP) ncmP.innerHTML = '<span class="text-gray-400"><i class="fas fa-times-circle text-xs mr-1"></i>未配置</span>';
                }
                if (ncmNickname) ncmNickname.textContent = '未登录';
                if (ncmVipStatus) ncmVipStatus.textContent = '请配置网易云账号';
                updateLoginButtons(false);
            }

            // QQ音乐状态 (异步更新)
            const qqStatus = document.getElementById('qq-status');
            const qqNickname = document.getElementById('qq-nickname');
            const qqVipStatus = document.getElementById('qq-vip-status');

            if (data.qq_status && data.qq_status.configured) {
                if (qqStatus) {
                    const qqP = qqStatus.querySelector('p:last-child');
                    if (qqP) qqP.innerHTML = '<span class="text-blue-400"><i class="fas fa-spinner fa-spin text-xs mr-1"></i>检测中...</span>';
                }
                updateQqStatus(); // Async call
            } else {
                if (qqStatus) {
                    const qqP = qqStatus.querySelector('p:last-child');
                    if (qqP) qqP.innerHTML = '<span class="text-gray-400"><i class="fas fa-times-circle text-xs mr-1"></i>未配置</span>';
                }
                if (qqNickname) qqNickname.textContent = '未登录';
                if (qqVipStatus) qqVipStatus.textContent = '请配置 QQ 音乐账号';
            }

            // 设置表单值


            document.getElementById('ncm-quality-select').value = data.ncm_quality || 'exhigh';
            document.getElementById('qq-quality-select').value = data.qq_quality || '320';
            autoDownloadToggle.checked = data.auto_download;
            autoDownloadLabel.textContent = data.auto_download ? '已启用' : '未启用';

            // 设置下载目录配置
            downloadModeSelect.value = data.download_mode || 'local';
            downloadDirInput.value = data.download_dir || '';

            // 设置整理配置
            if (data.organize_template) {

                // 高亮匹配的预设
                document.querySelectorAll('.template-preset').forEach(btn => {
                    if (btn.dataset.template === data.organize_template) {
                        btn.classList.add('border-purple-500');
                    } else {
                        btn.classList.remove('border-purple-500');
                    }
                });
            }

            updateDirContainers();

            // 设置 Emby 扫描间隔
            document.getElementById('emby-scan-interval').value = data.emby_scan_interval || 0;

            // 设置歌单同步间隔
            document.getElementById('playlist-sync-interval').value = data.playlist_sync_interval || 60;

            // QQ 音乐状态与其他设置 (清理掉重复的 QQ 逻辑)


        } catch (e) {
            console.error('加载配置失败:', e);
            updateLoginButtons(false);
        }
    }

    // 保存设置
    // 保存设置逻辑
    async function saveNcmSettings(e) {
        if (e) e.preventDefault();

        const saveStatus = document.getElementById('save-status');

        try {
            const ncmQualityVal = document.getElementById('ncm-quality-select')?.value || 'exhigh';
            const qqQualityVal = document.getElementById('qq-quality-select')?.value || '320';

            console.log('[Settings] Saving ncm_quality:', ncmQualityVal);
            console.log('[Settings] Saving qq_quality:', qqQualityVal);

            const formData = new FormData();
            formData.append('ncm_quality', ncmQualityVal);
            formData.append('qq_quality', qqQualityVal);
            formData.append('auto_download', autoDownloadToggle?.checked || false);
            formData.append('download_mode', downloadModeSelect?.value || 'local');
            formData.append('download_dir', downloadDirInput?.value || '');

            // 无论输入框在哪里，直接通过 ID 获取值
            const embyScanInput = document.getElementById('emby-scan-interval');
            if (embyScanInput) {
                console.log('[Settings] Saving emby_scan_interval:', embyScanInput.value);
                formData.append('emby_scan_interval', embyScanInput.value);
            }

            const playlistSyncInput = document.getElementById('playlist-sync-interval');
            if (playlistSyncInput) {
                formData.append('playlist_sync_interval', playlistSyncInput.value);
            }

            const res = await fetch('/api/settings/ncm', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.status === 'ok') {
                saveStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-green-500 bg-opacity-20 text-green-400 border border-green-500 border-opacity-30';
                saveStatus.innerHTML = '<i class="fas fa-check-circle mr-2"></i>设置已保存 (Quality: ' + ncmQualityVal + ')';

                // 强制稍微延迟后刷新，确保 DB 写入完成
                setTimeout(() => loadConfig(), 500);
            } else {
                saveStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
                saveStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>' + (data.message || '保存失败');
            }
            saveStatus.classList.remove('hidden');

            setTimeout(() => {
                saveStatus.classList.add('hidden');
            }, 3000);

        } catch (e) {
            console.error('保存失败:', e);
            if (saveStatus) {
                saveStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
                saveStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>保存失败: ' + e.message;
                saveStatus.classList.remove('hidden');
            } else {
                alert('保存失败: ' + e.message);
            }
        }
    }

    // 绑定事件
    document.getElementById('ncm-settings-form').addEventListener('submit', saveNcmSettings);

    // 暴露给全局，供 Notifications Tab 的按钮调用
    window.submitMainForm = saveNcmSettings;

    // ==================== Cookie 手动登录 ====================
    const cookieLoginModal = document.getElementById('cookie-login-modal');
    const btnCookieLogin = document.getElementById('btn-cookie-login');
    const btnCloseCookie = document.getElementById('btn-close-cookie');
    const btnCancelCookie = document.getElementById('btn-cancel-cookie');
    const btnSaveCookie = document.getElementById('btn-save-cookie');
    const cookieInput = document.getElementById('cookie-input');
    const cookieStatus = document.getElementById('cookie-status');

    // 打开 Cookie 输入弹窗
    btnCookieLogin.addEventListener('click', function () {
        cookieLoginModal.classList.remove('hidden');
        cookieInput.value = '';
        cookieStatus.classList.add('hidden');
    });

    // 关闭弹窗
    function closeCookieModal() {
        cookieLoginModal.classList.add('hidden');
    }
    btnCloseCookie.addEventListener('click', closeCookieModal);
    btnCancelCookie.addEventListener('click', closeCookieModal);
    cookieLoginModal.addEventListener('click', function (e) {
        if (e.target === cookieLoginModal) closeCookieModal();
    });

    // 验证并保存 Cookie
    btnSaveCookie.addEventListener('click', async function () {
        let cookieValue = cookieInput.value.trim();
        if (!cookieValue) {
            cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-500 bg-opacity-20 text-yellow-400 border border-yellow-500 border-opacity-30';
            cookieStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>请输入 MUSIC_U 值';
            cookieStatus.classList.remove('hidden');
            return;
        }

        // 自动添加 MUSIC_U= 前缀（如果用户粘贴了完整的也能处理）
        let cookie = cookieValue;
        if (!cookieValue.includes('MUSIC_U=')) {
            cookie = 'MUSIC_U=' + cookieValue;
        }

        btnSaveCookie.disabled = true;
        btnSaveCookie.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>验证中...';

        try {
            // 先验证 Cookie 是否有效
            const formData = new FormData();
            formData.append('cookie', cookie);

            const checkRes = await fetch('/api/ncm/check', {
                method: 'POST',
                body: formData
            });
            const checkData = await checkRes.json();

            if (checkData.logged_in) {
                // Cookie 有效，保存
                const saveRes = await fetch('/api/ncm/cookie/save', {
                    method: 'POST',
                    body: formData
                });
                const saveData = await saveRes.json();

                if (saveData.status === 'ok') {
                    cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-green-500 bg-opacity-20 text-green-400 border border-green-500 border-opacity-30';
                    cookieStatus.innerHTML = '<i class="fas fa-check-circle mr-2"></i>登录成功！欢迎，' + checkData.nickname;
                    cookieStatus.classList.remove('hidden');

                    // 2秒后关闭弹窗并刷新
                    setTimeout(() => {
                        closeCookieModal();
                        loadConfig();
                    }, 2000);
                } else {
                    throw new Error(saveData.message || '保存失败');
                }
            } else {
                cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
                cookieStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>' + (checkData.message || 'Cookie 无效或已过期');
                cookieStatus.classList.remove('hidden');
            }
        } catch (e) {
            console.error('验证 Cookie 失败:', e);
            cookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
            cookieStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>验证失败: ' + e.message;
            cookieStatus.classList.remove('hidden');
        } finally {
            btnSaveCookie.disabled = false;
            btnSaveCookie.innerHTML = '<i class="fas fa-check mr-2"></i>验证并保存';
        }
    });

    // ==================== QQ 音乐扫码登录 ====================
    const qqQrLoginModal = document.getElementById('qq-qr-login-modal');
    const btnQQQrLogin = document.getElementById('btn-qq-qr-login');
    const btnCloseQQQr = document.getElementById('btn-close-qq-qr');
    const btnRefreshQQQr = document.getElementById('btn-refresh-qq-qr');
    const qqQrLoading = document.getElementById('qq-qr-loading');
    const qqQrImageContainer = document.getElementById('qq-qr-image-container');
    const qqQrImage = document.getElementById('qq-qr-image');
    const qqQrStatus = document.getElementById('qq-qr-status');
    const qqQrScanned = document.getElementById('qq-qr-scanned');
    const qqQrScannedName = document.getElementById('qq-qr-scanned-name');
    const qqQrExpired = document.getElementById('qq-qr-expired');
    const qqQrSuccess = document.getElementById('qq-qr-success');
    const qqQrSuccessName = document.getElementById('qq-qr-success-name');
    const btnQQRefresh = document.getElementById('btn-qq-refresh');

    let qqCurrentSessionKey = null;
    let qqCheckInterval = null;

    // 打开 QQ 扫码登录弹窗
    btnQQQrLogin.addEventListener('click', function () {
        qqQrLoginModal.classList.remove('hidden');
        createQQQrCode();
    });

    // 关闭弹窗
    btnCloseQQQr.addEventListener('click', closeQQQrModal);
    qqQrLoginModal.addEventListener('click', function (e) {
        if (e.target === qqQrLoginModal) closeQQQrModal();
    });

    // 刷新二维码
    btnRefreshQQQr.addEventListener('click', createQQQrCode);

    function closeQQQrModal() {
        qqQrLoginModal.classList.add('hidden');
        if (qqCheckInterval) {
            clearInterval(qqCheckInterval);
            qqCheckInterval = null;
        }
    }

    function showQQQrLoading() {
        qqQrLoading.classList.remove('hidden');
        qqQrImageContainer.classList.add('hidden');
        qqQrScanned.classList.add('hidden');
        qqQrExpired.classList.add('hidden');
        qqQrSuccess.classList.add('hidden');
    }

    function showQQQrImage() {
        qqQrLoading.classList.add('hidden');
        qqQrImageContainer.classList.remove('hidden');
        qqQrScanned.classList.add('hidden');
        qqQrExpired.classList.add('hidden');
        qqQrSuccess.classList.add('hidden');
    }

    function showQQQrScanned(nickname) {
        qqQrLoading.classList.add('hidden');
        qqQrImageContainer.classList.add('hidden');
        qqQrScanned.classList.remove('hidden');
        qqQrExpired.classList.add('hidden');
        qqQrSuccess.classList.add('hidden');
        qqQrScannedName.textContent = nickname || '用户';
    }

    function showQQQrExpired() {
        qqQrLoading.classList.add('hidden');
        qqQrImageContainer.classList.add('hidden');
        qqQrScanned.classList.add('hidden');
        qqQrExpired.classList.remove('hidden');
        qqQrSuccess.classList.add('hidden');
    }

    function showQQQrSuccess(nickname) {
        qqQrLoading.classList.add('hidden');
        qqQrImageContainer.classList.add('hidden');
        qqQrScanned.classList.add('hidden');
        qqQrExpired.classList.add('hidden');
        qqQrSuccess.classList.remove('hidden');
        qqQrSuccessName.textContent = '欢迎，' + nickname;
    }

    async function createQQQrCode() {
        showQQQrLoading();
        if (qqCheckInterval) {
            clearInterval(qqCheckInterval);
            qqCheckInterval = null;
        }

        try {
            const res = await fetch('/api/qq/qr/create', { method: 'POST' });
            const data = await res.json();

            if (data.status === 'ok') {
                qqCurrentSessionKey = data.session_key;
                qqQrImage.src = data.qrcode_url;
                qqQrStatus.textContent = '请使用 QQ 音乐 App 扫描二维码';
                qqQrStatus.className = 'mt-4 text-gray-400';
                showQQQrImage();

                // 开始轮询检查状态
                startCheckingQQQr();
            } else {
                qqQrStatus.textContent = '生成二维码失败: ' + (data.message || '未知错误');
                qqQrStatus.className = 'mt-4 text-red-400';
                showQQQrImage();
            }
        } catch (e) {
            console.error('创建 QQ 二维码失败:', e);
            qqQrStatus.textContent = '网络错误，请重试';
            qqQrStatus.className = 'mt-4 text-red-400';
            showQQQrImage();
        }
    }

    function startCheckingQQQr() {
        qqCheckInterval = setInterval(async () => {
            if (!qqCurrentSessionKey) return;

            try {
                const formData = new FormData();
                formData.append('session_key', qqCurrentSessionKey);

                const res = await fetch('/api/qq/qr/check', {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();

                console.log('[QQ QR Check] 响应:', data);

                // 状态码: 0=等待扫码, 1=已扫码待确认, 2=二维码过期, 3=登录成功
                switch (data.code) {
                    case 0:
                        qqQrStatus.textContent = '等待扫描...';
                        qqQrStatus.className = 'mt-4 text-gray-400';
                        break;
                    case 1:
                        showQQQrScanned(data.nickname);
                        break;
                    case 2:
                        // 二维码过期
                        clearInterval(qqCheckInterval);
                        qqCheckInterval = null;
                        showQQQrExpired();
                        break;
                    case 3:
                        // 登录成功
                        console.log('[QQ QR Check] 登录成功!');
                        clearInterval(qqCheckInterval);
                        qqCheckInterval = null;

                        showQQQrSuccess(data.nickname || '用户');

                        // 2秒后关闭弹窗并刷新页面
                        setTimeout(() => {
                            closeQQQrModal();
                            loadConfig();
                        }, 2000);
                        break;
                    default:
                        console.log('[QQ QR Check] 未知状态码:', data.code, data.message);
                        if (data.status === 'error') {
                            qqQrStatus.textContent = data.message || '发生错误';
                            qqQrStatus.className = 'mt-4 text-red-400';
                        }
                }
            } catch (e) {
                console.error('检查 QQ 二维码状态失败:', e);
            }
        }, 2000);  // 每 2 秒检查一次
    }

    // QQ 音乐刷新 Cookie
    if (btnQQRefresh) {
        btnQQRefresh.addEventListener('click', async function () {
            btnQQRefresh.disabled = true;
            btnQQRefresh.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>刷新中...';

            try {
                const res = await fetch('/api/qq/refresh', { method: 'POST' });
                const data = await res.json();

                if (data.status === 'ok') {
                    alert('Cookie 刷新成功！');
                    loadConfig();
                } else {
                    alert('刷新失败: ' + (data.message || '未知错误'));
                }
            } catch (e) {
                console.error('刷新失败:', e);
                alert('刷新失败: ' + e.message);
            } finally {
                btnQQRefresh.disabled = false;
                btnQQRefresh.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>刷新 Cookie';
            }
        });
    }

    // ==================== QQ 音乐 Cookie 登录 ====================
    const qqCookieModal = document.getElementById('qq-cookie-modal');
    const btnQQCookieLogin = document.getElementById('btn-qq-cookie-login');
    const btnCloseQQCookie = document.getElementById('btn-close-qq-cookie');
    const btnCancelQQCookie = document.getElementById('btn-cancel-qq-cookie');
    const btnSaveQQCookie = document.getElementById('btn-save-qq-cookie');
    const qqCookieInput = document.getElementById('qq-cookie-input');
    const qqCookieStatus = document.getElementById('qq-cookie-status');
    const btnQQLogout = document.getElementById('btn-qq-logout');

    // 打开 QQ Cookie 输入弹窗
    btnQQCookieLogin.addEventListener('click', function () {
        qqCookieModal.classList.remove('hidden');
        qqCookieInput.value = '';
        qqCookieStatus.classList.add('hidden');
    });

    // 关闭弹窗
    function closeQQCookieModal() {
        qqCookieModal.classList.add('hidden');
    }
    btnCloseQQCookie.addEventListener('click', closeQQCookieModal);
    btnCancelQQCookie.addEventListener('click', closeQQCookieModal);
    qqCookieModal.addEventListener('click', function (e) {
        if (e.target === qqCookieModal) closeQQCookieModal();
    });

    // 验证并保存 QQ Cookie
    btnSaveQQCookie.addEventListener('click', async function () {
        const cookieValue = qqCookieInput.value.trim();

        if (!cookieValue) {
            qqCookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-500 bg-opacity-20 text-yellow-400 border border-yellow-500 border-opacity-30';
            qqCookieStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>请粘贴完整的 Cookie';
            qqCookieStatus.classList.remove('hidden');
            return;
        }

        // 检查必要字段
        if (!cookieValue.includes('uin=') || !cookieValue.includes('qm_keyst=')) {
            qqCookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-yellow-500 bg-opacity-20 text-yellow-400 border border-yellow-500 border-opacity-30';
            qqCookieStatus.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Cookie 缺少必要字段（uin 或 qm_keyst）';
            qqCookieStatus.classList.remove('hidden');
            return;
        }

        btnSaveQQCookie.disabled = true;
        btnSaveQQCookie.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>验证中...';

        try {
            const formData = new FormData();
            formData.append('cookie', cookieValue);

            // 先验证 Cookie 是否有效
            const checkRes = await fetch('/api/qq/check', {
                method: 'POST',
                body: formData
            });
            const checkData = await checkRes.json();

            if (checkData.logged_in) {
                // Cookie 有效，保存
                const saveRes = await fetch('/api/qq/save', {
                    method: 'POST',
                    body: formData
                });
                const saveData = await saveRes.json();

                if (saveData.status === 'ok') {
                    qqCookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-green-500 bg-opacity-20 text-green-400 border border-green-500 border-opacity-30';
                    qqCookieStatus.innerHTML = '<i class="fas fa-check-circle mr-2"></i>登录成功！欢迎，' + checkData.nickname;
                    qqCookieStatus.classList.remove('hidden');

                    // 2秒后关闭弹窗并刷新
                    setTimeout(() => {
                        closeQQCookieModal();
                        loadConfig();
                    }, 2000);
                } else {
                    throw new Error(saveData.message || '保存失败');
                }
            } else {
                qqCookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
                qqCookieStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>' + (checkData.message || 'Cookie 无效或已过期');
                qqCookieStatus.classList.remove('hidden');
            }
        } catch (e) {
            console.error('验证 QQ Cookie 失败:', e);
            qqCookieStatus.className = 'mt-4 p-3 rounded-lg text-sm bg-red-500 bg-opacity-20 text-red-400 border border-red-500 border-opacity-30';
            qqCookieStatus.innerHTML = '<i class="fas fa-times-circle mr-2"></i>验证失败: ' + e.message;
            qqCookieStatus.classList.remove('hidden');
        } finally {
            btnSaveQQCookie.disabled = false;
            btnSaveQQCookie.innerHTML = '<i class="fas fa-check mr-2"></i>验证并保存';
        }
    });

    // QQ 音乐退出登录
    btnQQLogout.addEventListener('click', async function () {
        if (!confirm('确定要清除 QQ音乐登录信息吗？')) return;

        try {
            const formData = new FormData();
            formData.append('cookie', '');  // 清空 Cookie

            const res = await fetch('/api/qq/save', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();

            if (data.status === 'ok') {
                loadConfig();
            } else {
                alert('清除失败: ' + (data.message || '未知错误'));
            }
        } catch (e) {
            console.error('清除失败:', e);
            alert('清除失败: ' + e.message);
        }
    });

    // ==================== Emby Webhook ====================

    // 设置 Webhook URL
    function updateWebhookUrl() {
        const webhookUrl = document.getElementById('webhook-url');
        const baseUrl = window.location.origin;
        webhookUrl.textContent = `${baseUrl}/webhook/emby`;
    }
    updateWebhookUrl();

    // 复制 Webhook URL
    function copyWebhookUrl() {
        const webhookUrl = document.getElementById('webhook-url').textContent;
        navigator.clipboard.writeText(webhookUrl).then(() => {
            // 显示复制成功提示
            const btn = event.currentTarget;
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check text-green-400"></i>';
            setTimeout(() => {
                btn.innerHTML = originalHTML;
            }, 1500);
        });
    }
    window.copyWebhookUrl = copyWebhookUrl;

    // 检查 Webhook 状态
    async function checkWebhookStatus() {
        try {
            const res = await fetch('/api/webhook/status');
            const data = await res.json();

            const indicator = document.getElementById('webhook-status-indicator');
            const text = document.getElementById('webhook-status-text');

            if (data.enabled) {
                indicator.classList.remove('bg-gray-500', 'bg-red-500');
                indicator.classList.add('bg-green-500');
                text.textContent = '已启用';
                text.classList.remove('text-gray-400', 'text-red-400');
                text.classList.add('text-green-400');
            }
        } catch (e) {
            console.error('检查 Webhook 状态失败:', e);
        }
    }

    // 测试 Webhook 通知
    async function testWebhookNotification() {
        const btn = event.currentTarget;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>发送中...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/webhook/test', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>已发送';
                btn.classList.remove('from-indigo-500', 'to-purple-600');
                btn.classList.add('from-green-500', 'to-green-600');

                // 更新状态显示
                const lastEventEl = document.getElementById('webhook-last-event');
                lastEventEl.textContent = '🎵 测试歌曲 - 测试艺术家';
                lastEventEl.classList.add('text-green-400');

                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('from-green-500', 'to-green-600');
                    btn.classList.add('from-indigo-500', 'to-purple-600');
                    btn.disabled = false;
                }, 3000);
            } else {
                throw new Error(data.message || '发送失败');
            }
        } catch (e) {
            console.error('测试通知失败:', e);
            btn.innerHTML = '<i class="fas fa-times mr-2"></i>发送失败';
            btn.classList.remove('from-indigo-500', 'to-purple-600');
            btn.classList.add('from-red-500', 'to-red-600');

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.classList.remove('from-red-500', 'to-red-600');
                btn.classList.add('from-indigo-500', 'to-purple-600');
                btn.disabled = false;
            }, 3000);
        }
    }
    window.testWebhookNotification = testWebhookNotification;

    // 测试日榜推送
    async function testDailyPush() {
        const btn = event.currentTarget;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>推送中...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/ranking/test/daily', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>已推送';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 3000);
            } else {
                throw new Error(data.message || '推送失败');
            }
        } catch (e) {
            console.error('日榜推送失败:', e);
            alert('推送失败: ' + e.message);
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }
    window.testDailyPush = testDailyPush;

    // 测试周榜推送
    async function testWeeklyPush() {
        const btn = event.currentTarget;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>推送中...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/ranking/test/weekly', { method: 'POST' });
            const data = await res.json();

            if (data.success) {
                btn.innerHTML = '<i class="fas fa-check mr-2"></i>已推送';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                }, 3000);
            } else {
                throw new Error(data.message || '推送失败');
            }
        } catch (e) {
            console.error('周榜推送失败:', e);
            alert('推送失败: ' + e.message);
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }
    window.testWeeklyPush = testWeeklyPush;

    // 获取最近的 Webhook 事件
    async function getRecentWebhookEvents() {
        try {
            const res = await fetch('/api/webhook/notifications');
            const data = await res.json();

            const lastEventEl = document.getElementById('webhook-last-event');
            if (data.notifications && data.notifications.length > 0) {
                const latest = data.notifications[data.notifications.length - 1];
                if (latest.type === 'library_new') {
                    lastEventEl.textContent = `🎵 ${latest.title} - ${latest.artist || '未知艺术家'}`;
                    lastEventEl.classList.add('text-green-400');

                    // 更新状态指示器
                    const indicator = document.getElementById('webhook-status-indicator');
                    indicator.classList.remove('bg-gray-500');
                    indicator.classList.add('bg-green-500', 'animate-pulse');
                    setTimeout(() => {
                        indicator.classList.remove('animate-pulse');
                    }, 3000);
                }
            }
        } catch (e) {
            // 静默失败
        }
    }

    // 初始化 Webhook 状态检查
    checkWebhookStatus();

    // 每 30 秒检查一次新事件
    setInterval(getRecentWebhookEvents, 30000);

    loadConfig();
    // Load Ranking Config
    async function loadRankingConfig() {
        try {
            const res = await fetch('/api/ranking/config');
            const data = await res.json();

            if (document.getElementById('ranking-target-chat')) {
                document.getElementById('ranking-target-chat').value = data.target_chat || '';
                document.getElementById('ranking-daily-time').value = data.daily_time || '';
                document.getElementById('ranking-daily-title').value = data.daily_title || '';
                document.getElementById('ranking-daily-subtitle').value = data.daily_subtitle || '';
                document.getElementById('ranking-weekly-time').value = data.weekly_time || '';
                document.getElementById('ranking-weekly-title').value = data.weekly_title || '';
            }
        } catch (e) { console.error(e); }
    }

    document.getElementById('btn-save-ranking')?.addEventListener('click', async () => {
        const btn = document.getElementById('btn-save-ranking');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
        btn.disabled = true;

        try {
            await fetch('/api/ranking/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    target_chat: document.getElementById('ranking-target-chat').value,
                    daily_time: document.getElementById('ranking-daily-time').value,
                    daily_title: document.getElementById('ranking-daily-title').value,
                    daily_subtitle: document.getElementById('ranking-daily-subtitle').value,
                    weekly_time: document.getElementById('ranking-weekly-time').value,
                    weekly_title: document.getElementById('ranking-weekly-title').value
                })
            });
            showToast('排行榜配置已保存', 'success');
        } catch (e) {
            showToast('保存失败', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    loadRankingConfig();

    // Load Email Config
    async function loadEmailConfig() {
        try {
            const res = await fetch('/api/email/config');
            const data = await res.json();

            if (document.getElementById('smtp-server')) {
                document.getElementById('smtp-server').value = data.smtp_server || '';
                document.getElementById('smtp-port').value = data.smtp_port || '';
                document.getElementById('smtp-user').value = data.smtp_user || '';
                document.getElementById('smtp-password').value = data.smtp_password || '';
                document.getElementById('smtp-from').value = data.smtp_from || '';
            }
        } catch (e) { console.error(e); }
    }

    document.getElementById('btn-save-email')?.addEventListener('click', async () => {
        const btn = document.getElementById('btn-save-email');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>保存中...';
        btn.disabled = true;

        try {
            await fetch('/api/email/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    smtp_server: document.getElementById('smtp-server').value,
                    smtp_port: document.getElementById('smtp-port').value,
                    smtp_user: document.getElementById('smtp-user').value,
                    smtp_password: document.getElementById('smtp-password').value,
                    smtp_from: document.getElementById('smtp-from').value
                })
            });
            showToast('邮件配置已保存', 'success');
        } catch (e) {
            showToast('保存失败', 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    });

    loadEmailConfig();


    // 目录浏览器 - 带缓存
    let currentDirPath = '';
    const dirCache = {};  // 缓存已加载的目录

    async function loadDirBrowser(path = '') {
        const browser = document.getElementById('dir-browser');
        const pathDisplay = document.getElementById('current-path-display');
        const hiddenInput = document.getElementById('cover-scan-dir');
        if (!browser) return;

        // 检查缓存
        if (dirCache[path]) {
            renderDirBrowser(browser, dirCache[path], pathDisplay, hiddenInput);
            return;
        }

        browser.innerHTML = '<div class="p-2 text-gray-400 text-sm">加载中...</div>';

        try {
            const resp = await fetch('/api/scan-covers/dirs?path=' + encodeURIComponent(path));
            const data = await resp.json();

            // 存入缓存
            dirCache[path] = data;

            renderDirBrowser(browser, data, pathDisplay, hiddenInput);

        } catch (e) {
            browser.innerHTML = '<div class="p-2 text-red-400 text-sm">加载失败</div>';
        }
    }

    loadDirBrowser();

    // 渲染目录浏览器
    function renderDirBrowser(browser, data, pathDisplay, hiddenInput) {
        currentDirPath = data.current || '';
        hiddenInput.value = currentDirPath;
        pathDisplay.textContent = currentDirPath ? `(${currentDirPath})` : '';

        let html = '';

        // 返回上级按钮
        if (data.parent !== undefined && data.current) {
            html += `<div class="dir-item px-3 py-2 hover:bg-white hover:bg-opacity-10 cursor-pointer border-b border-white border-opacity-5 flex items-center gap-2" data-path="${data.parent}">
                <i class="fas fa-arrow-left text-gray-400"></i>
                <span class="text-gray-300">← 返回上级</span>
            </div>`;
        }

        // 目录列表 - 显示全部，不限制数量
        if (data.items && data.items.length > 0) {
            for (const item of data.items) {
                html += `<div class="dir-item px-3 py-2 hover:bg-white hover:bg-opacity-10 cursor-pointer border-b border-white border-opacity-5 flex items-center gap-2" data-path="${item.path}">
                    <span>${item.name}</span>
                </div>`;
            }
        } else if (!data.parent) {
            html = '<div class="p-3 text-gray-500 text-sm">没有可用目录</div>';
        }

        // 选择当前目录按钮
        if (data.current) {
            html += `<div class="dir-select px-3 py-2 bg-green-600 bg-opacity-20 text-green-400 cursor-pointer flex items-center gap-2" data-select="${data.current}">
                <i class="fas fa-check"></i>
                <span>✓ 选择此目录: ${data.current.split('/').pop()}</span>
            </div>`;
        }

        browser.innerHTML = html;

        // 绑定点击事件
        browser.querySelectorAll('.dir-item').forEach(el => {
            el.addEventListener('click', () => loadDirBrowser(el.dataset.path));
        });
        browser.querySelectorAll('.dir-select').forEach(el => {
            el.addEventListener('click', () => {
                document.getElementById('cover-scan-status').textContent = '已选择: ' + el.dataset.select;
            });
        });

        // 重新绑定搜索
        const searchInput = document.getElementById('dir-search');
        if (searchInput && searchInput.value) {
            searchInput.dispatchEvent(new Event('input'));
        }
    }

    // 搜索过滤 - 改进版
    const dirSearchInput = document.getElementById('dir-search');
    if (dirSearchInput) {
        dirSearchInput.addEventListener('input', function (e) {
            const query = this.value.toLowerCase().trim();
            const items = document.querySelectorAll('#dir-browser .dir-item');
            console.log('Searching:', query, 'Items:', items.length);
            items.forEach(el => {
                const name = el.textContent.toLowerCase();
                if (query === '' || name.includes(query)) {
                    el.style.display = '';
                } else {
                    el.style.display = 'none';
                }
            });
        });
        dirSearchInput.addEventListener('keyup', function (e) {
            // 触发 input 事件
            this.dispatchEvent(new Event('input'));
        });
        console.log('Dir search initialized');
    }

    // 封面扫描功能
    document.getElementById('btn-preview-covers')?.addEventListener('click', async () => {
        const status = document.getElementById('cover-scan-status');
        const result = document.getElementById('cover-scan-result');
        const details = document.getElementById('cover-scan-details');
        const scanDir = document.getElementById('cover-scan-dir')?.value || '';

        status.textContent = '正在扫描...';
        result.classList.add('hidden');

        try {
            const resp = await fetch('/api/scan-covers/preview?dir=' + encodeURIComponent(scanDir));
            const data = await resp.json();

            if (data.success) {
                status.textContent = `共 ${data.total} 个文件夹缺少封面`;
                if (data.folders.length > 0) {
                    details.innerHTML = data.folders.map(f =>
                        `<div class="py-1 border-b border-gray-700">📁 ${f.path} <span class="text-gray-500">(${f.files} 首)</span></div>`
                    ).join('');
                    result.classList.remove('hidden');
                }
            } else {
                status.textContent = '扫描失败';
            }
        } catch (e) {
            status.textContent = '请求失败';
        }
    });

    document.getElementById('btn-scan-covers')?.addEventListener('click', async () => {
        const status = document.getElementById('cover-scan-status');
        const result = document.getElementById('cover-scan-result');
        const details = document.getElementById('cover-scan-details');
        const btn = document.getElementById('btn-scan-covers');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>处理中...';
        status.textContent = '';

        const scanDir = document.getElementById('cover-scan-dir')?.value || '';

        try {
            const resp = await fetch('/api/scan-covers?dir=' + encodeURIComponent(scanDir), { method: 'POST' });
            const data = await resp.json();

            if (data.success) {
                status.innerHTML = `<span class="text-green-400">✓ 扫描 ${data.scanned} 个文件夹，补全 ${data.filled} 个封面</span>`;
                if (data.errors && data.errors.length > 0) {
                    details.innerHTML = '<div class="text-yellow-400 mb-2">部分错误：</div>' +
                        data.errors.map(e => `<div class="text-gray-400">${e}</div>`).join('');
                    result.classList.remove('hidden');
                }
            } else {
                status.textContent = data.message || '扫描失败';
            }
        } catch (e) {
            status.textContent = '请求失败';
        }

        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-magic mr-2"></i>开始补全';
    });
</script>
{% endblock %}