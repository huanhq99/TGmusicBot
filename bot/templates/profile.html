{% extends "base.html" %}

{% block title %}个人中心 - TGmusicbot{% endblock %}

{% block content %}
<div class="mb-8 flex items-center justify-between">
    <div>
        <h2 class="text-2xl font-bold mb-1">个人中心</h2>
        <p class="text-gray-500">管理你的账户、会员权益与 Emby 绑定</p>
    </div>
    <div class="flex gap-3">
        {% if user.role != 'admin' %}
        <button onclick="dailyCheckin()" id="checkin-btn" class="btn-primary flex items-center gap-2">
            <i class="fas fa-calendar-check"></i>
            <span>每日签到</span>
        </button>
        {% else %}
        <span class="text-sm text-gray-400 flex items-center gap-2">
            <i class="fas fa-crown text-yellow-400"></i>
            管理员无需签到
        </span>
        {% endif %}
    </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <!-- 用户信息卡片 -->
    <div class="glass-card p-6 relative overflow-hidden">
        <div class="absolute top-0 right-0 p-4 opacity-10">
            <i class="fas fa-user-circle text-6xl"></i>
        </div>
        <h3 class="text-gray-400 text-sm font-medium mb-4 uppercase tracking-wider">当前用户</h3>
        <div class="flex items-center gap-4 mb-4">
            <div
                class="w-16 h-16 rounded-full bg-gradient-to-r from-blue-500 to-indigo-600 flex items-center justify-center text-2xl font-bold">
                {{ user.username[0] | upper }}
            </div>
            <div>
                <p class="text-xl font-bold">{{ user.username }}</p>
                <p class="text-sm text-gray-500">{{ user.email if user.email else '未绑定邮箱' }}</p>
                <span class="inline-block mt-1 px-2 py-0.5 rounded text-xs bg-gray-700 text-gray-300">
                    {{ '管理员' if user.role == 'admin' else '普通用户' }}
                </span>
            </div>
        </div>
    </div>

    <!-- 积分卡片 -->
    <div class="stat-card orange p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm mb-1">可用积分</p>
                <p class="stat-value" id="user-points">{{ user.points }}</p>
                <p class="text-xs text-gray-500 mt-1">可用于兑换会员天数</p>
            </div>
            <div class="stat-icon">
                <i class="fas fa-coins"></i>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-white border-opacity-10 flex gap-2">
            <button onclick="openRedeemModal()"
                class="text-sm text-orange-400 hover:text-orange-300 flex items-center gap-1">
                <i class="fas fa-exchange-alt"></i> 兑换会员
            </button>
        </div>
    </div>

    <!-- 会员状态卡片 -->
    <div class="stat-card {{ 'purple' if is_member else 'pink' }} p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-sm mb-1">会员状态</p>
                {% if is_member %}
                <p class="stat-value text-xl">有效期至</p>
                {% if user.expire_at %}
                <p class="text-lg font-bold text-white mt-1">{{ user.expire_at[:10] }}</p>
                <p class="text-xs text-green-400 mt-1">剩余 {{ days_left }} 天</p>
                {% else %}
                <p class="text-lg font-bold text-green-400 mt-1">永久会员</p>
                {% endif %}
                {% else %}
                <p class="stat-value text-xl">已过期</p>
                <p class="text-xs text-red-400 mt-1">请充值或兑换</p>
                {% endif %}
            </div>
            <div class="stat-icon">
                <i class="fas fa-crown"></i>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-white border-opacity-10">
            <button onclick="openCardModal()"
                class="text-sm text-purple-400 hover:text-purple-300 flex items-center gap-1">
                <i class="fas fa-ticket-alt"></i> 使用卡密充值
            </button>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Emby 账号绑定 -->
    <div class="glass-card p-6">
        <h3 class="font-semibold mb-4 flex items-center gap-2">
            <i class="fas fa-server text-green-400"></i>
            Emby 媒体服绑定
        </h3>

        {% if user.emby_username %}
        <div class="bg-green-500 bg-opacity-10 border border-green-500 border-opacity-20 rounded-xl p-4 mb-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-400">已绑定 Emby 账号</p>
                    <p class="text-lg font-bold text-green-400">{{ user.emby_username }}</p>
                </div>
                <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center">
                    <i class="fas fa-check text-white"></i>
                </div>
            </div>
            <div class="mt-3 pt-3 border-t border-green-500 border-opacity-20 flex gap-3">
                <button onclick="resetEmbyPassword()" class="text-xs text-green-400 hover:text-green-300">
                    <i class="fas fa-key mr-1"></i>重置密码
                </button>
                <button onclick="unbindEmby()" class="text-xs text-red-400 hover:text-red-300 ml-auto">
                    <i class="fas fa-unlink mr-1"></i>解绑账号
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-gray-800 bg-opacity-50 border border-gray-700 rounded-xl p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-gray-700 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-user-slash text-gray-400"></i>
            </div>
            <p class="text-gray-300 mb-1">未开通 Emby 账号</p>
            <p class="text-xs text-gray-500 mb-4">开通后可直接使用本系统账号密码登录 Emby 客户端</p>

            {% if is_member %}
            <button onclick="createEmbyUser()" class="btn-primary w-full py-2">
                <i class="fas fa-plus mr-2"></i>立即开通
            </button>
            {% else %}
            <button disabled class="bg-gray-700 text-gray-500 w-full py-2 rounded-lg cursor-not-allowed">
                <i class="fas fa-lock mr-2"></i>需要会员权限
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- 最近积分记录 -->
    <div class="glass-card p-6">
        <h3 class="font-semibold mb-4 flex items-center gap-2">
            <i class="fas fa-history text-blue-400"></i>
            积分记录
        </h3>
        <div class="space-y-3" id="points-log">
            <div class="text-center text-gray-500 py-4">
                <i class="fas fa-spinner fa-spin mr-2"></i>加载中...
            </div>
        </div>
    </div>
</div>

<!-- 卡密充值模态框 -->
<div id="card-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="glass-card p-6 w-full max-w-md mx-4 animate-fade-in">
        <h3 class="text-xl font-bold mb-4">使用卡密充值</h3>
        <div class="mb-4">
            <label class="block text-sm text-gray-400 mb-2">请输入卡密</label>
            <input type="text" id="card-key"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-indigo-500"
                placeholder="XXXX-XXXX-XXXX-XXXX">
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="closeCardModal()" class="px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800">取消</button>
            <button onclick="redeemCard()" class="btn-primary">确认充值</button>
        </div>
    </div>
</div>

<!-- 积分兑换模态框 -->
<div id="redeem-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
    <div class="glass-card p-6 w-full max-w-md mx-4 animate-fade-in">
        <h3 class="text-xl font-bold mb-4">积分兑换会员</h3>
        <p class="text-sm text-gray-400 mb-4">100 积分 = 1 天会员</p>
        <div class="mb-4">
            <label class="block text-sm text-gray-400 mb-2">兑换天数</label>
            <input type="number" id="redeem-days"
                class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-indigo-500"
                value="1" min="1">
            <p class="text-xs text-gray-500 mt-2">需要消耗: <span id="redeem-cost" class="text-orange-400">100</span> 积分</p>
        </div>
        <div class="flex justify-end gap-3">
            <button onclick="closeRedeemModal()"
                class="px-4 py-2 rounded-lg text-gray-400 hover:bg-gray-800">取消</button>
            <button onclick="redeemPoints()" class="btn-primary">确认兑换</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // 检查今日是否已签到
    async function checkCheckinStatus() {
        const lastCheckin = "{{ user.last_checkin_at }}"; // "YYYY-MM-DD ..."
        if (!lastCheckin) return;

        const today = new Date().toISOString().slice(0, 10);
        if (lastCheckin.startsWith(today)) {
            const btn = document.getElementById('checkin-btn');
            btn.innerHTML = '<i class="fas fa-check"></i><span>已签到</span>';
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.disabled = true;
        }
    }

    // 每日签到
    async function dailyCheckin() {
        try {
            const btn = document.getElementById('checkin-btn');
            btn.disabled = true;

            const res = await fetch('/api/user/checkin', { method: 'POST' });
            const data = await res.json();

            if (data.code === 200) {
                alert(`签到成功！获得 ${data.points} 积分`);
                location.reload();
            } else {
                alert(data.message);
                btn.disabled = false;
            }
        } catch (e) {
            alert('请求失败');
        }
    }

    // Emby 开通/绑定
    async function createEmbyUser() {
        if (!confirm('确定要开通 Emby 账号吗？将使用当前用户名和密码创建。')) return;

        try {
            const res = await fetch('/api/user/bind-emby', { method: 'POST' });
            const data = await res.json();
            if (data.code === 200) {
                alert('开通成功！');
                location.reload();
            } else {
                alert(data.message);
            }
        } catch (e) {
            alert('请求失败');
        }
    }

    // Emby 解绑
    async function unbindEmby() {
        if (!confirm('确定要解绑 Emby 账号吗？这将删除服务器上的 Emby 用户数据！')) return;
        // 注意：目前 bind-emby 接口似乎主要是创建。解绑逻辑可能需确认 API 支持。
        // 既然计划里没写 unbind API，暂时先做成提示联系管理员，或者复用 disable 逻辑？
        // 这里暂时只是 UI，具体逻辑需后端支持。
        alert('请联系管理员进行解绑操作。');
    }

    // 模态框操作
    function openCardModal() { document.getElementById('card-modal').classList.remove('hidden'); }
    function closeCardModal() { document.getElementById('card-modal').classList.add('hidden'); }

    function openRedeemModal() { document.getElementById('redeem-modal').classList.remove('hidden'); }
    function closeRedeemModal() { document.getElementById('redeem-modal').classList.add('hidden'); }

    // 监听输入计算积分消耗
    document.getElementById('redeem-days').addEventListener('input', function (e) {
        const cost = (parseInt(e.target.value) || 0) * 100;
        document.getElementById('redeem-cost').textContent = cost;
    });

    // 卡密充值
    async function redeemCard() {
        const key = document.getElementById('card-key').value.trim();
        if (!key) return alert('请输入卡密');

        try {
            const res = await fetch('/api/user/redeem/card', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ card_key: key })
            });
            const data = await res.json();
            if (data.code === 200) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        } catch (e) {
            alert('请求失败');
        }
    }

    // 积分兑换
    async function redeemPoints() {
        const days = parseInt(document.getElementById('redeem-days').value);
        if (days < 1) return;

        try {
            const res = await fetch('/api/user/redeem/points', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ days })
            });
            const data = await res.json();
            if (data.code === 200) {
                alert(data.message);
                location.reload();
            } else {
                alert(data.message);
            }
        } catch (e) {
            alert('请求失败');
        }
    }

    // 加载积分记录 (简单版，假设有 API，如果没有就隐藏)
    // 暂时用占位符，因为 `points_log` 表有，但 API `get_points_log` 好像没暴露给用户端
    // 咱们先隐藏这个，等后端加上再说
    document.getElementById('points-log').innerHTML = '<p class="text-sm text-gray-500 text-center">暂无近期记录</p>';

    checkCheckinStatus();
</script>
{% endblock %}